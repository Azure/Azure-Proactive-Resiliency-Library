<!DOCTYPE html>
<html><head><script src="/Azure-Proactive-Resiliency-Library/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=Azure-Proactive-Resiliency-Library/livereload" data-no-instant defer></script>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    
    <meta name="description" content="Best practices and resiliency recommendations for Virtual Machines and associated resources.">
    
    <link rel="alternate" type="application/rss+xml" href="http://localhost:1313/Azure-Proactive-Resiliency-Library/services/compute/virtual-machines/index.xml" title="Azure Proactive Resiliency Library (APRL)" />
    <link rel="canonical" href="http://localhost:1313/Azure-Proactive-Resiliency-Library/services/compute/virtual-machines/">

    <title>
        
        Virtual Machines | Azure Proactive Resiliency Library (APRL)
        
    </title>

    
    <link href="http://localhost:1313/Azure-Proactive-Resiliency-Library/css/fontawesome.min.css" rel="stylesheet">

    
    <link rel="stylesheet" href="http://localhost:1313/Azure-Proactive-Resiliency-Library/css/ace.min.css">

    

    
    

  
  <script type="text/javascript">
    (function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "kxpusfirv0");
  </script>

  
</head>
<body>

  <script src="https://unpkg.com/vanilla-back-to-top@7.2.1/dist/vanilla-back-to-top.min.js"></script>
  <script>addBackToTop({
      diameter: 75,
      backgroundColor: 'rgb(0, 123, 255)',
      textColor: '#ffffff',
      cornerOffset: 25,
      scrollDuration: 300
    })</script><nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow sticky-top" id="navbarMain">
    <div class="container">
        <div>
            <a class="navbar-brand" href="/Azure-Proactive-Resiliency-Library">
                
                    <img src="/Azure-Proactive-Resiliency-Library/media/img/aprl-white.png" />
                
                Azure Proactive Resiliency Library (APRL)
            </a>
        </div>
        
            <button class="navbar-toggler navbar-toggler-right collapsed" type="button" data-toggle="collapse" data-target="#navbarMainCollapse" aria-controls="navbarMainCollapse" aria-expanded="false" aria-label="Toggle navigation">
              <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarMainCollapse">
              <ul class="navbar-nav ml-auto">
                            <li class="nav-item">
                                <a class="nav-link" href="https://aka.ms/waf" target="_blank">
                                  Well-Architected Framework
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="https://aka.ms/aprl/repo" target="_blank">
                                  Source Code <i class='fab fa-github'></i>
                                </a>
                            </li>
              </ul>
            </div>
    </div>
    
    
</nav>
<div class="container-fluid">
    <div class="row">

      <div class="docs-sidenav order-0 col-12 col-md-3 col-lg-2 col-xl-2 position-sticky border-right"><nav class="navbar navbar-expand-md navbar-light pl-0">
    <button class="navbar-toggler navbar-toggler-right collapsed" type="button" data-toggle="collapse" data-target="#sidenav-left-collapse" aria-controls="sidenav-left-collapse" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

     <div class="collapse navbar-collapse align-items-start flex-column" id="sidenav-left-collapse">
            <form class="form-inline my-2 my-lg-0 searchbox">
                <input class="form-control mr-sm-2 w-100" data-search-input id="search-by" type="text" placeholder="Search">
            </form>

        

         <ul class="navbar-nav flex-column pt-3">
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/" class="nav-item my-1 parent haschildren
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/"><h6>Azure Services</h6></a>
        
        <ul class="list-unstyled ml-2">
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/ai-ml/" class="nav-item my-1 haschildren
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/ai-ml/"><h6>AI and ML</h6></a>
        
        <ul class="list-unstyled ml-2">
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/ai-ml/databricks/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/ai-ml/databricks/"><h6>Azure Databricks</h6></a>
        
    </li>
        </ul>
    </li>
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/batch/" class="nav-item my-1 haschildren
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/batch/"><h6>Batch</h6></a>
        
        <ul class="list-unstyled ml-2">
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/batch/batch-accounts/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/batch/batch-accounts/"><h6>Batch Accounts</h6></a>
        
    </li>
        </ul>
    </li>
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/compute/" class="nav-item my-1 parent haschildren
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/compute/"><h6>Compute</h6></a>
        
        <ul class="list-unstyled ml-2">
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/compute/site-recovery/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/compute/site-recovery/"><h6>Azure Site Recovery</h6></a>
        
    </li>
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/compute/compute-gallery/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/compute/compute-gallery/"><h6>Compute Gallery</h6></a>
        
    </li>
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/compute/image-templates/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/compute/image-templates/"><h6>Image Templates</h6></a>
        
    </li>
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/compute/virtual-machine-scale-sets/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/compute/virtual-machine-scale-sets/"><h6>Virtual Machine Scale Sets</h6></a>
        
    </li>
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/compute/virtual-machines/" class="nav-item my-1 active
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/compute/virtual-machines/"><h6>Virtual Machines</h6></a>
        
    </li>
        </ul>
    </li>
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/container/" class="nav-item my-1 haschildren
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/container/"><h6>Containers</h6></a>
        
        <ul class="list-unstyled ml-2">
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/container/aks/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/container/aks/"><h6>AKS</h6></a>
        
    </li>
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/container/container-registry/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/container/container-registry/"><h6>Container Registry</h6></a>
        
    </li>
        </ul>
    </li>
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/database/" class="nav-item my-1 haschildren
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/database/"><h6>Databases</h6></a>
        
        <ul class="list-unstyled ml-2">
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/database/sqldb/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/database/sqldb/"><h6>SQL DB</h6></a>
        
    </li>
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/database/cosmosdb/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/database/cosmosdb/"><h6>Cosmos DB</h6></a>
        
    </li>
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/database/db-for-mysql/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/database/db-for-mysql/"><h6>DB for MySQL</h6></a>
        
    </li>
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/database/db-for-postgresql/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/database/db-for-postgresql/"><h6>DB for PostgreSQL</h6></a>
        
    </li>
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/database/redis-cache/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/database/redis-cache/"><h6>Redis Cache</h6></a>
        
    </li>
        </ul>
    </li>
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/general/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/general/"><h6>General</h6></a>
        
    </li>
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/hybrid/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/hybrid/"><h6>Hybrid</h6></a>
        
    </li>
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/integration/" class="nav-item my-1 haschildren
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/integration/"><h6>Integration</h6></a>
        
        <ul class="list-unstyled ml-2">
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/integration/api-management/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/integration/api-management/"><h6>Api Management</h6></a>
        
    </li>
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/integration/event-grid/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/integration/event-grid/"><h6>Event Grid</h6></a>
        
    </li>
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/integration/event-hub/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/integration/event-hub/"><h6>Event Hub</h6></a>
        
    </li>
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/integration/service-bus/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/integration/service-bus/"><h6>Service Bus</h6></a>
        
    </li>
        </ul>
    </li>
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/iot/" class="nav-item my-1 haschildren
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/iot/"><h6>Internet of Things</h6></a>
        
        <ul class="list-unstyled ml-2">
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/iot/iot-hub/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/iot/iot-hub/"><h6>IoT Hub</h6></a>
        
    </li>
        </ul>
    </li>
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/management/" class="nav-item my-1 haschildren
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/management/"><h6>Management</h6></a>
        
        <ul class="list-unstyled ml-2">
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/management/automation-account/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/management/automation-account/"><h6>Automation Account</h6></a>
        
    </li>
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/management/management-group/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/management/management-group/"><h6>Management Groups</h6></a>
        
    </li>
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/management/resource-group/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/management/resource-group/"><h6>Resource Groups</h6></a>
        
    </li>
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/management/subscription/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/management/subscription/"><h6>Subscription</h6></a>
        
    </li>
        </ul>
    </li>
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/migration/" class="nav-item my-1 haschildren
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/migration/"><h6>Migration</h6></a>
        
        <ul class="list-unstyled ml-2">
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/migration/azure-backup/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/migration/azure-backup/"><h6>Azure Backup</h6></a>
        
    </li>
        </ul>
    </li>
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/monitoring/" class="nav-item my-1 haschildren
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/monitoring/"><h6>Monitoring</h6></a>
        
        <ul class="list-unstyled ml-2">
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/monitoring/application-insights/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/monitoring/application-insights/"><h6>Application Insights</h6></a>
        
    </li>
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/monitoring/log-analytics/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/monitoring/log-analytics/"><h6>Log Analytics</h6></a>
        
    </li>
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/monitoring/resource-health-alerts/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/monitoring/resource-health-alerts/"><h6>Resource Health Alerts</h6></a>
        
    </li>
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/monitoring/service-health-alerts/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/monitoring/service-health-alerts/"><h6>Service Health Alerts</h6></a>
        
    </li>
        </ul>
    </li>
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/networking/" class="nav-item my-1 haschildren
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/networking/"><h6>Networking</h6></a>
        
        <ul class="list-unstyled ml-2">
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/networking/application-gateway/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/networking/application-gateway/"><h6>Application Gateway</h6></a>
        
    </li>
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/networking/ddos-protection-plans/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/networking/ddos-protection-plans/"><h6>DDoS Protection Plans</h6></a>
        
    </li>
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/networking/expressroute-circuits/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/networking/expressroute-circuits/"><h6>ExpressRoute Circuits</h6></a>
        
    </li>
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/networking/expressroute-connection/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/networking/expressroute-connection/"><h6>ExpressRoute Connection</h6></a>
        
    </li>
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/networking/expressroute-direct/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/networking/expressroute-direct/"><h6>ExpressRoute Direct</h6></a>
        
    </li>
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/networking/expressroute-gateway/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/networking/expressroute-gateway/"><h6>ExpressRoute Gateway</h6></a>
        
    </li>
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/networking/expressroute-traffic-collector/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/networking/expressroute-traffic-collector/"><h6>ExpressRoute Traffic Collector</h6></a>
        
    </li>
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/networking/firewall/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/networking/firewall/"><h6>Firewall</h6></a>
        
    </li>
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/networking/front-door/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/networking/front-door/"><h6>Front Door</h6></a>
        
    </li>
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/networking/load-balancer/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/networking/load-balancer/"><h6>Load Balancer</h6></a>
        
    </li>
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/networking/network-security-group/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/networking/network-security-group/"><h6>Network Security Group</h6></a>
        
    </li>
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/networking/network-watcher/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/networking/network-watcher/"><h6>Network Watcher</h6></a>
        
    </li>
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/networking/private-dns-zones/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/networking/private-dns-zones/"><h6>Private DNS Zones</h6></a>
        
    </li>
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/networking/private-endpoints/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/networking/private-endpoints/"><h6>Private Endpoints</h6></a>
        
    </li>
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/networking/public-ip/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/networking/public-ip/"><h6>Public Ip</h6></a>
        
    </li>
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/networking/route-table/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/networking/route-table/"><h6>Route Table</h6></a>
        
    </li>
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/networking/traffic-manager/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/networking/traffic-manager/"><h6>Traffic Manager</h6></a>
        
    </li>
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/networking/virtual-networks/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/networking/virtual-networks/"><h6>Virtual Networks</h6></a>
        
    </li>
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/networking/vpn-gateway/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/networking/vpn-gateway/"><h6>VPN Gateway</h6></a>
        
    </li>
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/networking/web-application-firewall/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/networking/web-application-firewall/"><h6>Web Application Firewall</h6></a>
        
    </li>
        </ul>
    </li>
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/security/" class="nav-item my-1 haschildren
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/security/"><h6>Security</h6></a>
        
        <ul class="list-unstyled ml-2">
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/security/key-vault/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/security/key-vault/"><h6>Key Vault</h6></a>
        
    </li>
        </ul>
    </li>
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/specialized-workloads/" class="nav-item my-1 haschildren
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/specialized-workloads/"><h6>Specialized Workloads</h6></a>
        
        <ul class="list-unstyled ml-2">
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/specialized-workloads/azure-hpc/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/specialized-workloads/azure-hpc/"><h6>Azure High Performance Computing</h6></a>
        
    </li>
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/specialized-workloads/azure-virtual-desktop/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/specialized-workloads/azure-virtual-desktop/"><h6>Azure Virtual Desktop</h6></a>
        
    </li>
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/specialized-workloads/azure-vmware-solution/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/specialized-workloads/azure-vmware-solution/"><h6>Azure VMware Solution</h6></a>
        
    </li>
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/specialized-workloads/sap-on-azure/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/specialized-workloads/sap-on-azure/"><h6>SAP on Azure</h6></a>
        
    </li>
        </ul>
    </li>
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/storage/" class="nav-item my-1 haschildren
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/storage/"><h6>Storage</h6></a>
        
        <ul class="list-unstyled ml-2">
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/storage/azure-netapp-files/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/storage/azure-netapp-files/"><h6>Azure NetApp Files</h6></a>
        
    </li>
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/storage/storage-account/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/storage/storage-account/"><h6>Storage Accounts (Blob/Azure Data Lake Storage Gen2)</h6></a>
        
    </li>
        </ul>
    </li>
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/web/" class="nav-item my-1 haschildren
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/web/"><h6>Web</h6></a>
        
        <ul class="list-unstyled ml-2">
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/web/app-service-plan/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/web/app-service-plan/"><h6>App Service Plan</h6></a>
        
    </li>
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/web/signalr/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/web/signalr/"><h6>SignalR</h6></a>
        
    </li>
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/services/web/web-app/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/services/web/web-app/"><h6>Web App</h6></a>
        
    </li>
        </ul>
    </li>
        </ul>
    </li>
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/well-architected/" class="nav-item my-1 haschildren
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/well-architected/"><h6>Well Architected Framework</h6></a>
        
        <ul class="list-unstyled ml-2">
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/well-architected/1-define/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/well-architected/1-define/"><h6>1 - Define</h6></a>
        
    </li>
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/well-architected/2-design/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/well-architected/2-design/"><h6>2 - Design</h6></a>
        
    </li>
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/well-architected/3-test/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/well-architected/3-test/"><h6>3 - Test</h6></a>
        
    </li>
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/well-architected/4-deploy/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/well-architected/4-deploy/"><h6>4 - Deploy</h6></a>
        
    </li>
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/well-architected/5-monitor/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/well-architected/5-monitor/"><h6>5 - Monitor</h6></a>
        
    </li>
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/well-architected/6-respond/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/well-architected/6-respond/"><h6>6 - Respond</h6></a>
        
    </li>
        </ul>
    </li>
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/contributing/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/contributing/"><h6>Contributing</h6></a>
        
    </li>
    <li data-nav-id="/Azure-Proactive-Resiliency-Library/privacy/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/Azure-Proactive-Resiliency-Library/privacy/"><h6>Privacy</h6></a>
        
    </li>
        </ul>
    </div>
</nav>


</div>
        <div class="main col-12 order-1 col-md-9 col-lg-10 col-xl-10 py-3">
          

<div class="d-flex flex-column">
    <h1 class="js-title">Virtual Machines</h1>
    <div class="d-flex align-items-center">
        
    </div>
</div>

<hr>


<p>The presented resiliency recommendations in this guidance include Virtual Machines and dependent resources and settings.</p>
<h2 id="summary-of-recommendations">Summary of Recommendations
  <a href="#summary-of-recommendations">
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-link" viewBox="0 0 16 16">
      <path d="M6.354 5.5H4a3 3 0 0 0 0 6h3a3 3 0 0 0 2.83-4H9c-.086 0-.17.01-.25.031A2 2 0 0 1 7 10.5H4a2 2 0 1 1 0-4h1.535c.218-.376.495-.714.82-1z"/>
      <path d="M9 5.5a3 3 0 0 0-2.83 4h1.098A2 2 0 0 1 9 6.5h3a2 2 0 1 1 0 4h-1.535a4.02 4.02 0 0 1-.82 1H12a3 3 0 1 0 0-6H9z"/>
    </svg>
  </a>
</h2>

<div class="table table-striped" role="alert">
    <table>
<thead>
<tr>
<th style="text-align:left">Recommendation</th>
<th style="text-align:center">Category</th>
<th style="text-align:center">Impact</th>
<th style="text-align:center">State</th>
<th style="text-align:center">ARG Query Available</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><a href="#vm-1---run-production-workloads-on-two-or-more-vms-using-vmss-flex">VM-1 - Run production workloads on two or more VMs using VMSS Flex</a></td>
<td style="text-align:center">Availability</td>
<td style="text-align:center">High</td>
<td style="text-align:center">Verified</td>
<td style="text-align:center">Yes</td>
</tr>
<tr>
<td style="text-align:left"><a href="#vm-2---deploy-vms-across-availability-zones">VM-2 - Deploy VMs across Availability Zones</a></td>
<td style="text-align:center">Availability</td>
<td style="text-align:center">High</td>
<td style="text-align:center">Verified</td>
<td style="text-align:center">Yes</td>
</tr>
<tr>
<td style="text-align:left"><a href="#vm-3---migrate-vms-using-availability-sets-to-vmss-flex">VM-3 - Migrate VMs using availability sets to VMSS Flex</a></td>
<td style="text-align:center">Availability</td>
<td style="text-align:center">High</td>
<td style="text-align:center">Verified</td>
<td style="text-align:center">Yes</td>
</tr>
<tr>
<td style="text-align:left"><a href="#vm-4---replicate-vms-using-azure-site-recovery">VM-4 - Replicate VMs using Azure Site Recovery</a></td>
<td style="text-align:center">Disaster Recovery</td>
<td style="text-align:center">Medium</td>
<td style="text-align:center">Verified</td>
<td style="text-align:center">Yes</td>
</tr>
<tr>
<td style="text-align:left"><a href="#vm-5---use-managed-disks-for-vm-disks">VM-5 - Use Managed Disks for Virtual Machine disks</a></td>
<td style="text-align:center">Availability</td>
<td style="text-align:center">High</td>
<td style="text-align:center">Verified</td>
<td style="text-align:center">Yes</td>
</tr>
<tr>
<td style="text-align:left"><a href="#vm-6---host-application-or-database-data-on-a-data-disk">VM-6 - Host application or database data on a data disk</a></td>
<td style="text-align:center">System Efficiency</td>
<td style="text-align:center">Low</td>
<td style="text-align:center">Verified</td>
<td style="text-align:center">Yes</td>
</tr>
<tr>
<td style="text-align:left"><a href="#vm-7---backup-vms-with-azure-backup-service">VM-7 - Enable Backups on your VMs</a></td>
<td style="text-align:center">Disaster Recovery</td>
<td style="text-align:center">Medium</td>
<td style="text-align:center">Verified</td>
<td style="text-align:center">Yes</td>
</tr>
<tr>
<td style="text-align:left"><a href="#vm-8---production-vms-should-be-using-ssd-disks">VM-8 - Production VMs should be using SSD disks</a></td>
<td style="text-align:center">System Efficiency</td>
<td style="text-align:center">High</td>
<td style="text-align:center">Verified</td>
<td style="text-align:center">Yes</td>
</tr>
<tr>
<td style="text-align:left"><a href="#vm-9---review-vms-in-stopped-state">VM-9 - There are VMs in Stopped state</a></td>
<td style="text-align:center">Governance</td>
<td style="text-align:center">Low</td>
<td style="text-align:center">Verified</td>
<td style="text-align:center">Yes</td>
</tr>
<tr>
<td style="text-align:left"><a href="#vm-10---enable-accelerated-networking-accelnet">VM-10 - Accelerated Networking is not enabled</a></td>
<td style="text-align:center">System Efficiency</td>
<td style="text-align:center">Medium</td>
<td style="text-align:center">Verified</td>
<td style="text-align:center">Yes</td>
</tr>
<tr>
<td style="text-align:left"><a href="#vm-11---when-accelnet-is-enabled-you-must-manually-update-the-guestos-nic-driver">VM-11 - Accelerated Networking is enabled, make sure you update the GuestOS NIC driver every 6 months</a></td>
<td style="text-align:center">Governance</td>
<td style="text-align:center">Low</td>
<td style="text-align:center">Verified</td>
<td style="text-align:center">No</td>
</tr>
<tr>
<td style="text-align:left"><a href="#vm-12---vms-should-not-have-a-public-ip-directly-associated">VM-12 - VMs should not have a Public IP directly associated</a></td>
<td style="text-align:center">Access &amp; Security</td>
<td style="text-align:center">Medium</td>
<td style="text-align:center">Verified</td>
<td style="text-align:center">Yes</td>
</tr>
<tr>
<td style="text-align:left"><a href="#vm-13---vm-network-interfaces-and-associated-subnets-both-have-a-network-security-group-nsg-associated">VM-13 - VM network interfaces and associated subnets both have a Network Security Group (NSG) associated</a></td>
<td style="text-align:center">Access &amp; Security</td>
<td style="text-align:center">Low</td>
<td style="text-align:center">Verified</td>
<td style="text-align:center">Yes</td>
</tr>
<tr>
<td style="text-align:left"><a href="#vm-14---ip-forwarding-should-only-be-enabled-for-network-virtual-appliances">VM-14 - IP Forwarding should only be enabled for Network Virtual Appliances</a></td>
<td style="text-align:center">Access &amp; Security</td>
<td style="text-align:center">Medium</td>
<td style="text-align:center">Verified</td>
<td style="text-align:center">Yes</td>
</tr>
<tr>
<td style="text-align:left"><a href="#vm-15---customer-dns-servers-should-be-configured-in-the-virtual-network-level">VM-15 - Customer DNS Servers should be configured in the Virtual Network level</a></td>
<td style="text-align:center">Networking</td>
<td style="text-align:center">Low</td>
<td style="text-align:center">Verified</td>
<td style="text-align:center">Yes</td>
</tr>
<tr>
<td style="text-align:left"><a href="#vm-16---shared-disks-should-only-be-enabled-in-clustered-servers">VM-16 - Shared disks should only be enabled in Clustered servers</a></td>
<td style="text-align:center">Storage</td>
<td style="text-align:center">Medium</td>
<td style="text-align:center">Verified</td>
<td style="text-align:center">Yes</td>
</tr>
<tr>
<td style="text-align:left"><a href="#vm-17---network-access-to-the-vm-disk-should-be-set-to-disable-public-access-and-enable-private-access">VM-17 - The Network access to the VM disk is set to Enable Public access from all networks</a></td>
<td style="text-align:center">Access &amp; Security</td>
<td style="text-align:center">Low</td>
<td style="text-align:center">Verified</td>
<td style="text-align:center">Yes</td>
</tr>
<tr>
<td style="text-align:left"><a href="#vm-18---ensure-that-your-vms-are-compliant-with-azure-policies">VM-18 - Virtual Machine is not compliant with Azure Policies</a></td>
<td style="text-align:center">Governance</td>
<td style="text-align:center">Low</td>
<td style="text-align:center">Verified</td>
<td style="text-align:center">Yes</td>
</tr>
<tr>
<td style="text-align:left"><a href="#vm-19---enable-disk-encryption-and-data-at-rest-encryption-by-default">VM-19 - Enable disk encryption, Enable data at rest encryption by default</a></td>
<td style="text-align:center">Access &amp; Security</td>
<td style="text-align:center">Medium</td>
<td style="text-align:center">Verified</td>
<td style="text-align:center">Yes</td>
</tr>
<tr>
<td style="text-align:left"><a href="#vm-20---enable-vm-insights">VM-20 - Enable Insights to get more visibility into the health and performance of your virtual machine</a></td>
<td style="text-align:center">Monitoring</td>
<td style="text-align:center">Low</td>
<td style="text-align:center">Verified</td>
<td style="text-align:center">Yes</td>
</tr>
<tr>
<td style="text-align:left"><a href="#vm-21---configure-diagnostic-settings-for-all-azure-virtual-machines">VM-21 - Configure diagnostic settings for all Azure Virtual Machines</a></td>
<td style="text-align:center">Monitoring</td>
<td style="text-align:center">Low</td>
<td style="text-align:center">Preview</td>
<td style="text-align:center">Yes</td>
</tr>
<tr>
<td style="text-align:left"><a href="#vm-22---use-maintenance-configurations-for-the-vms">VM-22 - Use maintenance configurations for the Virtual Machine</a></td>
<td style="text-align:center">Governance</td>
<td style="text-align:center">High</td>
<td style="text-align:center">Preview</td>
<td style="text-align:center">Yes</td>
</tr>
<tr>
<td style="text-align:left"><a href="#vm-23---avoid-using-a-or-b-series-vm-sku-for-production-vms-that-need-the-full-performance-of-the-cpu-continuously">VM-23 - Avoid using A or B-Series VM Sku for production VMs that need the full performance of the CPU continuously</a></td>
<td style="text-align:center">System Efficiency</td>
<td style="text-align:center">High</td>
<td style="text-align:center">Preview</td>
<td style="text-align:center">Yes</td>
</tr>
<tr>
<td style="text-align:left"><a href="#vm-24---mission-critical-workloads-should-be-using-premium-or-ultra-disks">VM-24 - Mission Critical Workloads should be using Premium or Ultra Disks</a></td>
<td style="text-align:center">System Efficiency</td>
<td style="text-align:center">High</td>
<td style="text-align:center">Preview</td>
<td style="text-align:center">Yes</td>
</tr>
<tr>
<td style="text-align:left"><a href="#vm-26---ensure-all-vms-part-of-a-sql-always-on-cluster-have-the-same-specifications-and-configurations">VM-26 - Ensure all VMs part of a SQL Always-on cluster have the same specifications and configurations</a></td>
<td style="text-align:center">Application Resiliency</td>
<td style="text-align:center">High</td>
<td style="text-align:center">Preview</td>
<td style="text-align:center">No</td>
</tr>
<tr>
<td style="text-align:left"><a href="#vm-27---use-azure-boost-vms-for-maintenance-sensitive-workload">VM-27 - Use Azure Boost VMs for Maintenance sensitive workload</a></td>
<td style="text-align:center">Availability</td>
<td style="text-align:center">Medium</td>
<td style="text-align:center">Preview</td>
<td style="text-align:center">No</td>
</tr>
<tr>
<td style="text-align:left"><a href="#vm-28---enable-scheduled-events-for-maintenance-sensitive-workload-vms">VM-28 - Enable Scheduled Events for Maintenance sensitive workload VMs</a></td>
<td style="text-align:center">Availability</td>
<td style="text-align:center">Medium</td>
<td style="text-align:center">Preview</td>
<td style="text-align:center">No</td>
</tr>
</tbody>
</table>

</div>


<div class="alert alert-info" role="alert">
    Definitions of states can be found <a href="http://localhost:1313/Azure-Proactive-Resiliency-Library/#definitions-of-terms-used-in-aprl">here</a>
</div>

<h2 id="recommendations-details">Recommendations Details
  <a href="#recommendations-details">
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-link" viewBox="0 0 16 16">
      <path d="M6.354 5.5H4a3 3 0 0 0 0 6h3a3 3 0 0 0 2.83-4H9c-.086 0-.17.01-.25.031A2 2 0 0 1 7 10.5H4a2 2 0 1 1 0-4h1.535c.218-.376.495-.714.82-1z"/>
      <path d="M9 5.5a3 3 0 0 0-2.83 4h1.098A2 2 0 0 1 9 6.5h3a2 2 0 1 1 0 4h-1.535a4.02 4.02 0 0 1-.82 1H12a3 3 0 1 0 0-6H9z"/>
    </svg>
  </a>
</h2>
<h3 id="vm-1---run-production-workloads-on-two-or-more-vms-using-vmss-flex">VM-1 - Run production workloads on two or more VMs using VMSS Flex
  <a href="#vm-1---run-production-workloads-on-two-or-more-vms-using-vmss-flex">
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-link" viewBox="0 0 16 16">
      <path d="M6.354 5.5H4a3 3 0 0 0 0 6h3a3 3 0 0 0 2.83-4H9c-.086 0-.17.01-.25.031A2 2 0 0 1 7 10.5H4a2 2 0 1 1 0-4h1.535c.218-.376.495-.714.82-1z"/>
      <path d="M9 5.5a3 3 0 0 0-2.83 4h1.098A2 2 0 0 1 9 6.5h3a2 2 0 1 1 0 4h-1.535a4.02 4.02 0 0 1-.82 1H12a3 3 0 1 0 0-6H9z"/>
    </svg>
  </a>
</h3>
<p><strong>Category: Availability</strong></p>
<p><strong>Impact: High</strong></p>
<p><strong>Guidance</strong></p>
<p>Production VM workloads should be deployed on multiple VMs and grouped together in a VMSS Flex instance. VMSS Flex intelligently distributes VMs across the platform to minimize the impact of platform faults and platform updates on a workload. A workload running on single instance VMs, even when those instances are spread across availability zones, cannot receive the same protection because the platform has no way of knowing the VMs are related to each other.</p>
<p><strong>Resources</strong></p>
<ul>
<li><a href="https://learn.microsoft.com/azure/virtual-machine-scale-sets/virtual-machine-scale-sets-orchestration-modes#what-has-changed-with-flexible-orchestration-mode">What has changed with Flexible orchestration mode</a></li>
<li><a href="https://learn.microsoft.com/azure/virtual-machine-scale-sets/virtual-machine-scale-sets-attach-detach-vm?branch=main&amp;tabs=portal-1%2Cportal-2%2Cportal-3">Attach or detach a Virtual Machine to or from a Virtual Machine Scale Set</a></li>
</ul>
<p><strong>Resource Graph Query</strong></p>


<button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#collapse_30278c2aed" aria-expanded="false">
    Show/Hide Query/Script
</button>

<div class="collapse" id="collapse_30278c2aed">
  <div class="card card-body">
    







    
    




<div class="position-relative">
    <div class="position-absolute" style="right:0;">
        <button class="btn btn-light" data-clipboard-target="#clipboard_d9a0c5a7c6">
        Copy
        </button>
    </div>
    <div id="clipboard_d9a0c5a7c6">
    <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#f92672">//</span> Azure Resource Graph Query
</span></span><span style="display:flex;"><span><span style="color:#f92672">//</span> Find <span style="color:#66d9ef">all</span> VMs that <span style="color:#66d9ef">are</span> <span style="color:#66d9ef">not</span> associated <span style="color:#66d9ef">with</span> a VMSS Flex instance
</span></span><span style="display:flex;"><span>resources
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> <span style="color:#66d9ef">type</span> <span style="color:#f92672">=~</span> <span style="color:#e6db74">&#39;Microsoft.Compute/virtualMachines&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> <span style="color:#66d9ef">isnull</span>(properties.virtualMachineScaleSet.id)
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> project recommendationId<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;vm-1&#34;</span>, name, id, tags
</span></span></code></pre></div>
    </div>
</div>






  </div>
</div>
<p><br><br></p>
<h3 id="vm-2---deploy-vms-across-availability-zones">VM-2 - Deploy VMs across Availability Zones
  <a href="#vm-2---deploy-vms-across-availability-zones">
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-link" viewBox="0 0 16 16">
      <path d="M6.354 5.5H4a3 3 0 0 0 0 6h3a3 3 0 0 0 2.83-4H9c-.086 0-.17.01-.25.031A2 2 0 0 1 7 10.5H4a2 2 0 1 1 0-4h1.535c.218-.376.495-.714.82-1z"/>
      <path d="M9 5.5a3 3 0 0 0-2.83 4h1.098A2 2 0 0 1 9 6.5h3a2 2 0 1 1 0 4h-1.535a4.02 4.02 0 0 1-.82 1H12a3 3 0 1 0 0-6H9z"/>
    </svg>
  </a>
</h3>
<p><strong>Category: Availability</strong></p>
<p><strong>Impact: High</strong></p>
<p><strong>Guidance</strong></p>
<p>Azure Availability Zones are physically separate locations within each Azure region that are tolerant to local failures. Use availability zones to protect your applications and data against unlikely datacenter failures.</p>
<p><strong>Resources</strong></p>
<ul>
<li><a href="https://learn.microsoft.com/azure/virtual-machines/create-portal-availability-zone?tabs=standard">Create virtual machines in an availability zone using the Azure portal</a></li>
</ul>
<p><strong>Resource Graph Query</strong></p>


<button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#collapse_70f5bd7aa6" aria-expanded="false">
    Show/Hide Query/Script
</button>

<div class="collapse" id="collapse_70f5bd7aa6">
  <div class="card card-body">
    







    
    




<div class="position-relative">
    <div class="position-absolute" style="right:0;">
        <button class="btn btn-light" data-clipboard-target="#clipboard_84388ec7a7">
        Copy
        </button>
    </div>
    <div id="clipboard_84388ec7a7">
    <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#f92672">//</span> Azure Resource Graph Query
</span></span><span style="display:flex;"><span><span style="color:#f92672">//</span> Find <span style="color:#66d9ef">all</span> VMs that <span style="color:#66d9ef">are</span> <span style="color:#66d9ef">not</span> assigned <span style="color:#66d9ef">to</span> a <span style="color:#66d9ef">Zone</span>
</span></span><span style="display:flex;"><span>Resources
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> <span style="color:#66d9ef">type</span> <span style="color:#f92672">=~</span> <span style="color:#e6db74">&#39;Microsoft.Compute/virtualMachines&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> <span style="color:#66d9ef">isnull</span>(zones)
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> project recommendationId<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;vm-2&#34;</span>, name, id, tags, param1<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;No Zone&#34;</span>
</span></span></code></pre></div>
    </div>
</div>






  </div>
</div>
<p><br><br></p>
<h3 id="vm-3---migrate-vms-using-availability-sets-to-vmss-flex">VM-3 - Migrate VMs using availability sets to VMSS Flex
  <a href="#vm-3---migrate-vms-using-availability-sets-to-vmss-flex">
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-link" viewBox="0 0 16 16">
      <path d="M6.354 5.5H4a3 3 0 0 0 0 6h3a3 3 0 0 0 2.83-4H9c-.086 0-.17.01-.25.031A2 2 0 0 1 7 10.5H4a2 2 0 1 1 0-4h1.535c.218-.376.495-.714.82-1z"/>
      <path d="M9 5.5a3 3 0 0 0-2.83 4h1.098A2 2 0 0 1 9 6.5h3a2 2 0 1 1 0 4h-1.535a4.02 4.02 0 0 1-.82 1H12a3 3 0 1 0 0-6H9z"/>
    </svg>
  </a>
</h3>
<p><strong>Category: Availability</strong></p>
<p><strong>Impact: High</strong></p>
<p><strong>Guidance</strong></p>
<p>Availability sets will be retired in the near future. Modernize your workloads by migrating them from VMs to VMSS Flex. With VMSS Flex, you can deploy your VMs in one of two ways:</p>
<p>. Across zones
. In the same zone, but across fault domains (FDs) and update domains (UD) automatically.</p>
<p>In an N-tier application, it&rsquo;s recommended that you place each application tier into its own VMSS Flex.</p>
<p><strong>Resources</strong></p>
<ul>
<li><a href="https://learn.microsoft.com/azure/architecture/checklist/resiliency-per-service#virtual-machines">Resiliency checklist for Virtual Machines</a></li>
</ul>
<p><strong>Resource Graph Query</strong></p>


<button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#collapse_dff189572a" aria-expanded="false">
    Show/Hide Query/Script
</button>

<div class="collapse" id="collapse_dff189572a">
  <div class="card card-body">
    







    
    




<div class="position-relative">
    <div class="position-absolute" style="right:0;">
        <button class="btn btn-light" data-clipboard-target="#clipboard_ad5acf6e45">
        Copy
        </button>
    </div>
    <div id="clipboard_ad5acf6e45">
    <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#f92672">//</span> Azure Resource Graph Query
</span></span><span style="display:flex;"><span><span style="color:#f92672">//</span> Find <span style="color:#66d9ef">all</span> VMs <span style="color:#66d9ef">using</span> Availability <span style="color:#66d9ef">Sets</span>
</span></span><span style="display:flex;"><span>resources
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> <span style="color:#66d9ef">type</span> <span style="color:#f92672">=~</span> <span style="color:#e6db74">&#39;Microsoft.Compute/virtualMachines&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> isnotnull(properties.availabilitySet)
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> project recommendationId <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;vm-3&#34;</span>, name, id, tags, param1<span style="color:#f92672">=</span>strcat(<span style="color:#e6db74">&#34;availabilitySet: &#34;</span>,properties.availabilitySet.id)
</span></span></code></pre></div>
    </div>
</div>






  </div>
</div>
<p><br><br></p>
<h3 id="vm-4---replicate-vms-using-azure-site-recovery">VM-4 - Replicate VMs using Azure Site Recovery
  <a href="#vm-4---replicate-vms-using-azure-site-recovery">
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-link" viewBox="0 0 16 16">
      <path d="M6.354 5.5H4a3 3 0 0 0 0 6h3a3 3 0 0 0 2.83-4H9c-.086 0-.17.01-.25.031A2 2 0 0 1 7 10.5H4a2 2 0 1 1 0-4h1.535c.218-.376.495-.714.82-1z"/>
      <path d="M9 5.5a3 3 0 0 0-2.83 4h1.098A2 2 0 0 1 9 6.5h3a2 2 0 1 1 0 4h-1.535a4.02 4.02 0 0 1-.82 1H12a3 3 0 1 0 0-6H9z"/>
    </svg>
  </a>
</h3>
<p><strong>Category: Disaster Recovery</strong></p>
<p><strong>Impact: Medium</strong></p>
<p><strong>Guidance</strong></p>
<p>When you replicate Azure VMs using Site Recovery, all the VM disks are continuously replicated to the target region asynchronously. The recovery points are created every few minutes. This gives you a Recovery Point Objective (RPO) in the order of minutes. You can conduct disaster recovery drills as many times as you want, without affecting the production application or the ongoing replication.</p>
<p><strong>Resources</strong></p>
<ul>
<li><a href="https://learn.microsoft.com/azure/architecture/checklist/resiliency-per-service#virtual-machines">Resiliency checklist for Virtual Machines</a></li>
<li><a href="https://learn.microsoft.com/azure/site-recovery/site-recovery-test-failover-to-azure">Run a test failover (disaster recovery drill) to Azure</a></li>
</ul>
<p><strong>Resource Graph Query</strong></p>


<button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#collapse_8c12dd4819" aria-expanded="false">
    Show/Hide Query/Script
</button>

<div class="collapse" id="collapse_8c12dd4819">
  <div class="card card-body">
    







    
    




<div class="position-relative">
    <div class="position-absolute" style="right:0;">
        <button class="btn btn-light" data-clipboard-target="#clipboard_d6bbc5ac0a">
        Copy
        </button>
    </div>
    <div id="clipboard_d6bbc5ac0a">
    <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#f92672">//</span> Azure Resource Graph Query
</span></span><span style="display:flex;"><span><span style="color:#f92672">//</span> Find <span style="color:#66d9ef">all</span> VMs that <span style="color:#66d9ef">do</span> <span style="color:#66d9ef">NOT</span> have replication <span style="color:#66d9ef">with</span> ASR enabled
</span></span><span style="display:flex;"><span><span style="color:#f92672">//</span> Run query <span style="color:#66d9ef">to</span> see results.
</span></span><span style="display:flex;"><span>resources
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> <span style="color:#66d9ef">type</span> <span style="color:#f92672">=~</span> <span style="color:#e6db74">&#39;Microsoft.Compute/virtualMachines&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> project name, id, tags
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#66d9ef">join</span> kind<span style="color:#f92672">=</span>leftouter (
</span></span><span style="display:flex;"><span>    recoveryservicesresources
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> <span style="color:#66d9ef">type</span> <span style="color:#f92672">=~</span> <span style="color:#e6db74">&#39;Microsoft.RecoveryServices/vaults/replicationFabrics/replicationProtectionContainers/replicationProtectedItems&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> properties.providerSpecificDetails.dataSourceInfo.datasourceType <span style="color:#f92672">=~</span> <span style="color:#e6db74">&#39;AzureVm&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> project id<span style="color:#f92672">=</span>properties.providerSpecificDetails.dataSourceInfo.resourceId
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> extend name<span style="color:#f92672">=</span>strcat_array(array_slice(split(id, <span style="color:#e6db74">&#39;/&#39;</span>), <span style="color:#ae81ff">8</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>), <span style="color:#e6db74">&#39;/&#39;</span>)
</span></span><span style="display:flex;"><span>) <span style="color:#66d9ef">on</span> name
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> <span style="color:#66d9ef">isnull</span>(id1)
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> project<span style="color:#f92672">-</span>away id1
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> project<span style="color:#f92672">-</span>away name1
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> project recommendationId <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;vm-4&#34;</span>, name, id, tags
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> id <span style="color:#66d9ef">asc</span>
</span></span></code></pre></div>
    </div>
</div>






  </div>
</div>
<p><br><br></p>
<h3 id="vm-5---use-managed-disks-for-vm-disks">VM-5 - Use Managed Disks for VM disks
  <a href="#vm-5---use-managed-disks-for-vm-disks">
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-link" viewBox="0 0 16 16">
      <path d="M6.354 5.5H4a3 3 0 0 0 0 6h3a3 3 0 0 0 2.83-4H9c-.086 0-.17.01-.25.031A2 2 0 0 1 7 10.5H4a2 2 0 1 1 0-4h1.535c.218-.376.495-.714.82-1z"/>
      <path d="M9 5.5a3 3 0 0 0-2.83 4h1.098A2 2 0 0 1 9 6.5h3a2 2 0 1 1 0 4h-1.535a4.02 4.02 0 0 1-.82 1H12a3 3 0 1 0 0-6H9z"/>
    </svg>
  </a>
</h3>
<p><strong>Category: Availability</strong></p>
<p><strong>Impact: High</strong></p>
<p><strong>Guidance</strong></p>
<p>Azure unmanaged disks will be fully retired on September 30, 2025. If you use unmanaged disks, start planning the migration now.</p>
<p><strong>Resources</strong></p>
<ul>
<li><a href="https://learn.microsoft.com/azure/virtual-machines/unmanaged-disks-deprecation">Migrate your Azure unmanaged disks by Sep 30, 2025</a></li>
<li><a href="https://learn.microsoft.com/azure/virtual-machines/windows/convert-unmanaged-to-managed-disks">Migrate Windows VM from unmanaged disks to managed disks</a></li>
<li><a href="https://learn.microsoft.com/azure/virtual-machines/linux/convert-unmanaged-to-managed-disks">Migrate Linux VM from unmanaged disks to managed disks</a></li>
</ul>
<p><strong>Resource Graph Query</strong></p>


<button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#collapse_2ffb115d2c" aria-expanded="false">
    Show/Hide Query/Script
</button>

<div class="collapse" id="collapse_2ffb115d2c">
  <div class="card card-body">
    







    
    




<div class="position-relative">
    <div class="position-absolute" style="right:0;">
        <button class="btn btn-light" data-clipboard-target="#clipboard_31e38d7700">
        Copy
        </button>
    </div>
    <div id="clipboard_31e38d7700">
    <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#f92672">//</span> Azure Resource Graph Query
</span></span><span style="display:flex;"><span><span style="color:#f92672">//</span> Find <span style="color:#66d9ef">all</span> VMs that <span style="color:#66d9ef">are</span> <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">using</span> Managed Disks
</span></span><span style="display:flex;"><span>Resources
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> <span style="color:#66d9ef">type</span> <span style="color:#f92672">=~</span> <span style="color:#e6db74">&#39;Microsoft.Compute/virtualMachines&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> <span style="color:#66d9ef">isnull</span>(properties.storageProfile.osDisk.managedDisk)
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> project recommendationId <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;vm-5&#34;</span>, name, id, tags
</span></span></code></pre></div>
    </div>
</div>






  </div>
</div>
<p><br><br></p>
<h3 id="vm-6---host-application-or-database-data-on-a-data-disk">VM-6 - Host application or database data on a data disk
  <a href="#vm-6---host-application-or-database-data-on-a-data-disk">
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-link" viewBox="0 0 16 16">
      <path d="M6.354 5.5H4a3 3 0 0 0 0 6h3a3 3 0 0 0 2.83-4H9c-.086 0-.17.01-.25.031A2 2 0 0 1 7 10.5H4a2 2 0 1 1 0-4h1.535c.218-.376.495-.714.82-1z"/>
      <path d="M9 5.5a3 3 0 0 0-2.83 4h1.098A2 2 0 0 1 9 6.5h3a2 2 0 1 1 0 4h-1.535a4.02 4.02 0 0 1-.82 1H12a3 3 0 1 0 0-6H9z"/>
    </svg>
  </a>
</h3>
<p><strong>Category: System Efficiency</strong></p>
<p><strong>Impact: Low</strong></p>
<p><strong>Guidance</strong></p>
<p>A data disk is a managed disk that&rsquo;s attached to a virtual machine to store application data, or other data you need to keep. Data disks are registered as SCSI drives and are labeled with a letter that you choose. Hosting you data on a data disk also helps with flexibility when backuping or restoring data, as well as migrating the disk without having to migrate the entire Virtual Machine and Operating System. You will be able to also select a different disk sku, with different type, size, and performance that meet your requirements.</p>
<p><strong>Resources</strong></p>
<ul>
<li><a href="https://learn.microsoft.com/azure/virtual-machines/managed-disks-overview#data-disk">Introduction to Azure managed disks - Data disks</a></li>
</ul>
<p><strong>Resource Graph Query</strong></p>


<button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#collapse_d464d296b9" aria-expanded="false">
    Show/Hide Query/Script
</button>

<div class="collapse" id="collapse_d464d296b9">
  <div class="card card-body">
    







    
    




<div class="position-relative">
    <div class="position-absolute" style="right:0;">
        <button class="btn btn-light" data-clipboard-target="#clipboard_fc4aeb8f1c">
        Copy
        </button>
    </div>
    <div id="clipboard_fc4aeb8f1c">
    <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#f92672">//</span> Azure Resource Graph Query
</span></span><span style="display:flex;"><span><span style="color:#f92672">//</span> Find <span style="color:#66d9ef">all</span> VMs that <span style="color:#66d9ef">only</span> have a single Disk
</span></span><span style="display:flex;"><span>Resources
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> <span style="color:#66d9ef">type</span> <span style="color:#f92672">=~</span> <span style="color:#e6db74">&#39;Microsoft.Compute/virtualMachines&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> array_length(properties.storageProfile.dataDisks) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> project recommendationId <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;vm-6&#34;</span>, name, id, tags
</span></span></code></pre></div>
    </div>
</div>






  </div>
</div>
<p><br><br></p>
<h3 id="vm-7---backup-vms-with-azure-backup-service">VM-7 - Backup VMs with Azure Backup service
  <a href="#vm-7---backup-vms-with-azure-backup-service">
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-link" viewBox="0 0 16 16">
      <path d="M6.354 5.5H4a3 3 0 0 0 0 6h3a3 3 0 0 0 2.83-4H9c-.086 0-.17.01-.25.031A2 2 0 0 1 7 10.5H4a2 2 0 1 1 0-4h1.535c.218-.376.495-.714.82-1z"/>
      <path d="M9 5.5a3 3 0 0 0-2.83 4h1.098A2 2 0 0 1 9 6.5h3a2 2 0 1 1 0 4h-1.535a4.02 4.02 0 0 1-.82 1H12a3 3 0 1 0 0-6H9z"/>
    </svg>
  </a>
</h3>
<p><strong>Category: Disaster Recovery</strong></p>
<p><strong>Impact: Medium</strong></p>
<p><strong>Guidance</strong></p>
<p>Enable backups for your virtual machines to secure and quickly recover your data. The Azure Backup service provides simple, secure, and cost-effective solutions to back up your data and recover it from the Microsoft Azure cloud.</p>
<p><strong>Resources</strong></p>
<ul>
<li><a href="https://learn.microsoft.com/azure/backup/backup-overview">What is the Azure Backup service?</a></li>
</ul>
<p><strong>Resource Graph Query</strong></p>


<button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#collapse_25e182f87f" aria-expanded="false">
    Show/Hide Query/Script
</button>

<div class="collapse" id="collapse_25e182f87f">
  <div class="card card-body">
    







    
    




<div class="position-relative">
    <div class="position-absolute" style="right:0;">
        <button class="btn btn-light" data-clipboard-target="#clipboard_17f40f3e3d">
        Copy
        </button>
    </div>
    <div id="clipboard_17f40f3e3d">
    <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#f92672">//</span> Azure Resource Graph Query
</span></span><span style="display:flex;"><span><span style="color:#f92672">//</span> Find <span style="color:#66d9ef">all</span> VMs that <span style="color:#66d9ef">do</span> <span style="color:#66d9ef">NOT</span> have Backup enabled
</span></span><span style="display:flex;"><span><span style="color:#f92672">//</span> Run query <span style="color:#66d9ef">to</span> see results.
</span></span><span style="display:flex;"><span>resources
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> <span style="color:#66d9ef">type</span> <span style="color:#f92672">=~</span> <span style="color:#e6db74">&#39;Microsoft.Compute/virtualMachines&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> project name, id, tags
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#66d9ef">join</span> kind<span style="color:#f92672">=</span>leftouter (
</span></span><span style="display:flex;"><span>    recoveryservicesresources
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> <span style="color:#66d9ef">type</span> <span style="color:#f92672">=~</span> <span style="color:#e6db74">&#39;Microsoft.RecoveryServices/vaults/backupFabrics/protectionContainers/protectedItems&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> properties.dataSourceInfo.datasourceType <span style="color:#f92672">=~</span> <span style="color:#e6db74">&#39;Microsoft.Compute/virtualMachines&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> project idBackupEnabled<span style="color:#f92672">=</span>properties.sourceResourceId
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> extend name<span style="color:#f92672">=</span>strcat_array(array_slice(split(idBackupEnabled, <span style="color:#e6db74">&#39;/&#39;</span>), <span style="color:#ae81ff">8</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>), <span style="color:#e6db74">&#39;/&#39;</span>)
</span></span><span style="display:flex;"><span>) <span style="color:#66d9ef">on</span> name
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> <span style="color:#66d9ef">isnull</span>(idBackupEnabled)
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> project<span style="color:#f92672">-</span>away idBackupEnabled
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> project<span style="color:#f92672">-</span>away name1
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> project recommendationId <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;vm-7&#34;</span>, name, id, tags
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> id <span style="color:#66d9ef">asc</span>
</span></span></code></pre></div>
    </div>
</div>






  </div>
</div>
<p><br><br></p>
<h3 id="vm-8---production-vms-should-be-using-ssd-disks">VM-8 - Production VMs should be using SSD disks
  <a href="#vm-8---production-vms-should-be-using-ssd-disks">
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-link" viewBox="0 0 16 16">
      <path d="M6.354 5.5H4a3 3 0 0 0 0 6h3a3 3 0 0 0 2.83-4H9c-.086 0-.17.01-.25.031A2 2 0 0 1 7 10.5H4a2 2 0 1 1 0-4h1.535c.218-.376.495-.714.82-1z"/>
      <path d="M9 5.5a3 3 0 0 0-2.83 4h1.098A2 2 0 0 1 9 6.5h3a2 2 0 1 1 0 4h-1.535a4.02 4.02 0 0 1-.82 1H12a3 3 0 1 0 0-6H9z"/>
    </svg>
  </a>
</h3>
<p><strong>Category: System Efficiency</strong></p>
<p><strong>Impact: High</strong></p>
<p><strong>Guidance</strong></p>
<p>Premium SSD disks offer high-performance, low-latency disk support for I/O-intensive applications and production workloads. Standard SSD Disks are a cost-effective storage option optimized for workloads that need consistent performance at lower IOPS levels.</p>
<p>It is recommended that you:</p>
<ul>
<li>Use Standard HDD disks for Dev/Test scenarios and less critical workloads at lowest cost.</li>
<li>Use Premium SSD disks instead of Standard HDD disks with your premium-capable VMs. For any Single Instance VM using premium storage for all Operating System Disks and Data Disks, Azure guarantees VM connectivity of at least 99.9%.</li>
</ul>
<p>If you want to upgrade from Standard HDD to Premium SSD disks, consider the following issues:</p>
<ul>
<li>Upgrading requires a VM reboot and this process takes 3-5 minutes to complete.</li>
<li>If VMs are mission-critical production VMs, evaluate the improved availability against the cost of premium disks.</li>
</ul>
<p>This does not apply to ephemeral disks
<strong>Resources</strong></p>
<ul>
<li><a href="https://learn.microsoft.com/azure/virtual-machines/disks-types#premium-ssd">Azure managed disk types</a></li>
</ul>
<p><strong>Resource Graph Query</strong></p>


<button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#collapse_411806b572" aria-expanded="false">
    Show/Hide Query/Script
</button>

<div class="collapse" id="collapse_411806b572">
  <div class="card card-body">
    







    
    




<div class="position-relative">
    <div class="position-absolute" style="right:0;">
        <button class="btn btn-light" data-clipboard-target="#clipboard_6da42634c7">
        Copy
        </button>
    </div>
    <div id="clipboard_6da42634c7">
    <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#f92672">//</span> Azure Resource Graph Query
</span></span><span style="display:flex;"><span><span style="color:#f92672">//</span> Find <span style="color:#66d9ef">all</span> disks <span style="color:#66d9ef">with</span> StandardHDD sku attached <span style="color:#66d9ef">to</span> VMs
</span></span><span style="display:flex;"><span>Resources
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> <span style="color:#66d9ef">type</span> <span style="color:#f92672">=~</span> <span style="color:#e6db74">&#39;Microsoft.Compute/disks&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> sku.name <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;Standard_LRS&#39;</span> <span style="color:#66d9ef">and</span> sku.tier <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;Standard&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> managedBy <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> project recommendationId <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;vm-8&#34;</span>, name, id, tags, param1<span style="color:#f92672">=</span>strcat(<span style="color:#e6db74">&#34;managedBy: &#34;</span>, managedBy)
</span></span></code></pre></div>
    </div>
</div>






  </div>
</div>
<p><br><br></p>
<h3 id="vm-9---review-vms-in-stopped-state">VM-9 - Review VMs in stopped state
  <a href="#vm-9---review-vms-in-stopped-state">
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-link" viewBox="0 0 16 16">
      <path d="M6.354 5.5H4a3 3 0 0 0 0 6h3a3 3 0 0 0 2.83-4H9c-.086 0-.17.01-.25.031A2 2 0 0 1 7 10.5H4a2 2 0 1 1 0-4h1.535c.218-.376.495-.714.82-1z"/>
      <path d="M9 5.5a3 3 0 0 0-2.83 4h1.098A2 2 0 0 1 9 6.5h3a2 2 0 1 1 0 4h-1.535a4.02 4.02 0 0 1-.82 1H12a3 3 0 1 0 0-6H9z"/>
    </svg>
  </a>
</h3>
<p><strong>Category: Governance</strong></p>
<p><strong>Impact: Low</strong></p>
<p><strong>Guidance</strong></p>
<p>Azure Virtual Machines (VM) instances go through different states. There are provisioning and power states. If a Virtual Machine is not running that indicates the Virtual Machine might facing an issue or is no longer necessary and could be removed helping to reduce costs.</p>
<p><strong>Resources</strong></p>
<ul>
<li><a href="https://learn.microsoft.com/azure/virtual-machines/states-billing?context=%2Ftroubleshoot%2Fazure%2Fvirtual-machines%2Fcontext%2Fcontext#power-states-and-billing">States and billing status of Azure Virtual Machines</a></li>
</ul>
<p><strong>Resource Graph Query</strong></p>


<button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#collapse_99fae61b5b" aria-expanded="false">
    Show/Hide Query/Script
</button>

<div class="collapse" id="collapse_99fae61b5b">
  <div class="card card-body">
    







    
    




<div class="position-relative">
    <div class="position-absolute" style="right:0;">
        <button class="btn btn-light" data-clipboard-target="#clipboard_cd5d1c4d28">
        Copy
        </button>
    </div>
    <div id="clipboard_cd5d1c4d28">
    <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#f92672">//</span> Azure Resource Graph Query
</span></span><span style="display:flex;"><span><span style="color:#f92672">//</span> Find <span style="color:#66d9ef">all</span> VMs that <span style="color:#66d9ef">are</span> <span style="color:#66d9ef">NOT</span> running
</span></span><span style="display:flex;"><span>Resources
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> <span style="color:#66d9ef">type</span> <span style="color:#f92672">=~</span> <span style="color:#e6db74">&#39;Microsoft.Compute/virtualMachines&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> properties.extended.instanceView.powerState.displayStatus <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;VM running&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> project recommendationId <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;vm-9&#34;</span>, name, id, tags
</span></span></code></pre></div>
    </div>
</div>






  </div>
</div>
<p><br><br></p>
<h3 id="vm-10---enable-accelerated-networking-accelnet">VM-10 - Enable Accelerated Networking (AccelNet)
  <a href="#vm-10---enable-accelerated-networking-accelnet">
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-link" viewBox="0 0 16 16">
      <path d="M6.354 5.5H4a3 3 0 0 0 0 6h3a3 3 0 0 0 2.83-4H9c-.086 0-.17.01-.25.031A2 2 0 0 1 7 10.5H4a2 2 0 1 1 0-4h1.535c.218-.376.495-.714.82-1z"/>
      <path d="M9 5.5a3 3 0 0 0-2.83 4h1.098A2 2 0 0 1 9 6.5h3a2 2 0 1 1 0 4h-1.535a4.02 4.02 0 0 1-.82 1H12a3 3 0 1 0 0-6H9z"/>
    </svg>
  </a>
</h3>
<p><strong>Category: System Efficiency</strong></p>
<p><strong>Impact: Medium</strong></p>
<p><strong>Guidance</strong></p>
<p>Accelerated networking enables single root I/O virtualization (SR-IOV) to a VM, greatly improving its networking performance. This high-performance path bypasses the host from the data path, which reduces latency, jitter, and CPU utilization for the most demanding network workloads on supported VM types.</p>
<p>This configuration is not always required, evaluate this option according to the workload requirements.</p>
<p><strong>Resources</strong></p>
<ul>
<li><a href="https://learn.microsoft.com/azure/virtual-network/accelerated-networking-overview">Accelerated Networking (AccelNet) overview</a></li>
</ul>
<p><strong>Resource Graph Query</strong></p>


<button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#collapse_61ada2b3ac" aria-expanded="false">
    Show/Hide Query/Script
</button>

<div class="collapse" id="collapse_61ada2b3ac">
  <div class="card card-body">
    







    
    




<div class="position-relative">
    <div class="position-absolute" style="right:0;">
        <button class="btn btn-light" data-clipboard-target="#clipboard_8e1b5fd1c3">
        Copy
        </button>
    </div>
    <div id="clipboard_8e1b5fd1c3">
    <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#f92672">//</span> Azure Resource Graph Query
</span></span><span style="display:flex;"><span><span style="color:#f92672">//</span> Find <span style="color:#66d9ef">all</span> VM NICs that <span style="color:#66d9ef">do</span> <span style="color:#66d9ef">not</span> have Accelerated Networking enabled
</span></span><span style="display:flex;"><span>resources
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> <span style="color:#66d9ef">type</span> <span style="color:#f92672">=~</span> <span style="color:#e6db74">&#39;Microsoft.Compute/virtualMachines&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> mv<span style="color:#f92672">-</span>expand nic <span style="color:#f92672">=</span> properties.networkProfile.networkInterfaces
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> project name, id, tags, lowerCaseNicId <span style="color:#f92672">=</span> tolower(nic.id), vmSize <span style="color:#f92672">=</span> tostring(properties.hardwareProfile.vmSize)
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#66d9ef">join</span> kind <span style="color:#f92672">=</span> <span style="color:#66d9ef">inner</span> (
</span></span><span style="display:flex;"><span>    resources
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> <span style="color:#66d9ef">type</span> <span style="color:#f92672">=~</span> <span style="color:#e6db74">&#39;Microsoft.Network/networkInterfaces&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> properties.enableAcceleratedNetworking <span style="color:#f92672">==</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> project nicName <span style="color:#f92672">=</span> split(id, <span style="color:#e6db74">&#34;/&#34;</span>)[<span style="color:#ae81ff">8</span>], lowerCaseNicId <span style="color:#f92672">=</span> tolower(id)
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">on</span> lowerCaseNicId
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> summarize nicNames <span style="color:#f92672">=</span> make_set(nicName) <span style="color:#66d9ef">by</span> name, id, tostring(tags), vmSize
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> extend param1 <span style="color:#f92672">=</span> strcat(<span style="color:#e6db74">&#34;NicName: &#34;</span>, strcat_array(nicNames, <span style="color:#e6db74">&#34;, &#34;</span>)), param2 <span style="color:#f92672">=</span> strcat(<span style="color:#e6db74">&#34;VMSize: &#34;</span>, vmSize)
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> project recommendationId <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;vm-10&#34;</span>, name, id, tags, param1, param2
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> id <span style="color:#66d9ef">asc</span>
</span></span></code></pre></div>
    </div>
</div>






  </div>
</div>
<p><br><br></p>
<h3 id="vm-11---when-accelnet-is-enabled-you-must-manually-update-the-guestos-nic-driver">VM-11 - When AccelNet is enabled, you must manually update the GuestOS NIC driver
  <a href="#vm-11---when-accelnet-is-enabled-you-must-manually-update-the-guestos-nic-driver">
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-link" viewBox="0 0 16 16">
      <path d="M6.354 5.5H4a3 3 0 0 0 0 6h3a3 3 0 0 0 2.83-4H9c-.086 0-.17.01-.25.031A2 2 0 0 1 7 10.5H4a2 2 0 1 1 0-4h1.535c.218-.376.495-.714.82-1z"/>
      <path d="M9 5.5a3 3 0 0 0-2.83 4h1.098A2 2 0 0 1 9 6.5h3a2 2 0 1 1 0 4h-1.535a4.02 4.02 0 0 1-.82 1H12a3 3 0 1 0 0-6H9z"/>
    </svg>
  </a>
</h3>
<p><strong>Category: Governance</strong></p>
<p><strong>Impact: Low</strong></p>
<p><strong>Guidance</strong></p>
<p>When Accelerated Networking is enabled the default Azure Virtual Network interface in the GuestOS is replaced for a Mellanox and consecutively its driver is provided from a 3rd party vendor. Marketplace images maintained by Microsoft are offered with the latest version of Mellanox drivers, however, once the Virtual Machine is deployed, the customer is responsible for maintaining the driver up to date.</p>
<p><strong>Resources</strong></p>
<ul>
<li><a href="https://learn.microsoft.com/azure/virtual-network/accelerated-networking-overview">Accelerated Networking (AccelNet) overview</a></li>
</ul>
<p><strong>Resource Graph Query</strong></p>


<button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#collapse_c8e45339d9" aria-expanded="false">
    Show/Hide Query/Script
</button>

<div class="collapse" id="collapse_c8e45339d9">
  <div class="card card-body">
    







    
    




<div class="position-relative">
    <div class="position-absolute" style="right:0;">
        <button class="btn btn-light" data-clipboard-target="#clipboard_f8ad57f9af">
        Copy
        </button>
    </div>
    <div id="clipboard_f8ad57f9af">
    <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#f92672">//</span> cannot<span style="color:#f92672">-</span>be<span style="color:#f92672">-</span>validated<span style="color:#f92672">-</span><span style="color:#66d9ef">with</span><span style="color:#f92672">-</span>arg
</span></span></code></pre></div>
    </div>
</div>






  </div>
</div>
<p><br><br></p>
<h3 id="vm-12---vms-should-not-have-a-public-ip-directly-associated">VM-12 - VMs should not have a Public IP directly associated
  <a href="#vm-12---vms-should-not-have-a-public-ip-directly-associated">
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-link" viewBox="0 0 16 16">
      <path d="M6.354 5.5H4a3 3 0 0 0 0 6h3a3 3 0 0 0 2.83-4H9c-.086 0-.17.01-.25.031A2 2 0 0 1 7 10.5H4a2 2 0 1 1 0-4h1.535c.218-.376.495-.714.82-1z"/>
      <path d="M9 5.5a3 3 0 0 0-2.83 4h1.098A2 2 0 0 1 9 6.5h3a2 2 0 1 1 0 4h-1.535a4.02 4.02 0 0 1-.82 1H12a3 3 0 1 0 0-6H9z"/>
    </svg>
  </a>
</h3>
<p><strong>Category: Access &amp; Security</strong></p>
<p><strong>Impact: Medium</strong></p>
<p><strong>Guidance</strong></p>
<p>If a Virtual Machine requires outbound internet connectivity we recommend the use of NAT Gateway or Azure Firewall, this will help to increase security and resiliency of the service as both services have much higher availability and SNAT ports. For inbound internet connectivity we recommend using a load balancing solution such as Azure Load Balancer and Application Gateway.</p>
<p><strong>Resources</strong></p>
<ul>
<li><a href="https://learn.microsoft.com/azure/load-balancer/load-balancer-outbound-connections">Use Source Network Address Translation (SNAT) for outbound connections</a></li>
</ul>
<p><strong>Resource Graph Query</strong></p>


<button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#collapse_20009a3c5a" aria-expanded="false">
    Show/Hide Query/Script
</button>

<div class="collapse" id="collapse_20009a3c5a">
  <div class="card card-body">
    







    
    




<div class="position-relative">
    <div class="position-absolute" style="right:0;">
        <button class="btn btn-light" data-clipboard-target="#clipboard_3999e67ffe">
        Copy
        </button>
    </div>
    <div id="clipboard_3999e67ffe">
    <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#f92672">//</span> Azure Resource Graph Query
</span></span><span style="display:flex;"><span><span style="color:#f92672">//</span> Find <span style="color:#66d9ef">all</span> VMs <span style="color:#66d9ef">with</span> PublicIPs directly associated <span style="color:#66d9ef">with</span> them
</span></span><span style="display:flex;"><span>Resources
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> <span style="color:#66d9ef">type</span> <span style="color:#f92672">=~</span> <span style="color:#e6db74">&#39;Microsoft.Compute/virtualMachines&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> isnotnull(properties.networkProfile.networkInterfaces)
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> mv<span style="color:#f92672">-</span>expand nic<span style="color:#f92672">=</span>properties.networkProfile.networkInterfaces
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> project name, id, tags, nicId <span style="color:#f92672">=</span> nic.id
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> extend nicId <span style="color:#f92672">=</span> tostring(nicId)
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#66d9ef">join</span> kind<span style="color:#f92672">=</span><span style="color:#66d9ef">inner</span> (
</span></span><span style="display:flex;"><span>    Resources
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> <span style="color:#66d9ef">type</span> <span style="color:#f92672">=~</span> <span style="color:#e6db74">&#39;Microsoft.Network/networkInterfaces&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> isnotnull(properties.ipConfigurations)
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> mv<span style="color:#f92672">-</span>expand ipconfig<span style="color:#f92672">=</span>properties.ipConfigurations
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> extend publicIp <span style="color:#f92672">=</span> tostring(ipconfig.properties.publicIPAddress.id)
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> publicIp <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> project name, nicId <span style="color:#f92672">=</span> tostring(id), publicIp
</span></span><span style="display:flex;"><span>) <span style="color:#66d9ef">on</span> nicId
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> project recommendationId <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;vm-12&#34;</span>, name, id, tags
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> id <span style="color:#66d9ef">asc</span>
</span></span></code></pre></div>
    </div>
</div>






  </div>
</div>
<p><br><br></p>
<h3 id="vm-13---vm-network-interfaces-and-associated-subnets-both-have-a-network-security-group-nsg-associated">VM-13 - VM network interfaces and associated subnets both have a Network Security Group (NSG) associated
  <a href="#vm-13---vm-network-interfaces-and-associated-subnets-both-have-a-network-security-group-nsg-associated">
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-link" viewBox="0 0 16 16">
      <path d="M6.354 5.5H4a3 3 0 0 0 0 6h3a3 3 0 0 0 2.83-4H9c-.086 0-.17.01-.25.031A2 2 0 0 1 7 10.5H4a2 2 0 1 1 0-4h1.535c.218-.376.495-.714.82-1z"/>
      <path d="M9 5.5a3 3 0 0 0-2.83 4h1.098A2 2 0 0 1 9 6.5h3a2 2 0 1 1 0 4h-1.535a4.02 4.02 0 0 1-.82 1H12a3 3 0 1 0 0-6H9z"/>
    </svg>
  </a>
</h3>
<p><strong>Category: Access &amp; Security</strong></p>
<p><strong>Impact: Low</strong></p>
<p><strong>Guidance</strong></p>
<p>Unless you have a specific reason to, we recommend that you associate a network security group to a subnet, or a network interface, but not both. Since rules in a network security group associated to a subnet can conflict with rules in a network security group associated to a network interface, you can have unexpected communication problems that require troubleshooting.</p>
<p><strong>Resources</strong></p>
<ul>
<li><a href="https://learn.microsoft.com/azure/virtual-network/network-security-group-how-it-works#intra-subnet-traffic">How network security groups filter network traffic</a></li>
</ul>
<p><strong>Resource Graph Query</strong></p>


<button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#collapse_254fd0151e" aria-expanded="false">
    Show/Hide Query/Script
</button>

<div class="collapse" id="collapse_254fd0151e">
  <div class="card card-body">
    







    
    




<div class="position-relative">
    <div class="position-absolute" style="right:0;">
        <button class="btn btn-light" data-clipboard-target="#clipboard_bba58e0d69">
        Copy
        </button>
    </div>
    <div id="clipboard_bba58e0d69">
    <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#f92672">//</span> Azure Resource Graph Query
</span></span><span style="display:flex;"><span><span style="color:#f92672">//</span> Provides a list <span style="color:#66d9ef">of</span> virtual machines <span style="color:#66d9ef">and</span> associated NICs that <span style="color:#66d9ef">do</span> have an NSG associated <span style="color:#66d9ef">to</span> them <span style="color:#66d9ef">and</span> also an NSG associated <span style="color:#66d9ef">to</span> the subnet.
</span></span><span style="display:flex;"><span>Resources
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> <span style="color:#66d9ef">type</span> <span style="color:#f92672">=~</span> <span style="color:#e6db74">&#39;Microsoft.Network/networkInterfaces&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> isnotnull(properties.networkSecurityGroup)
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> mv<span style="color:#f92672">-</span>expand ipConfigurations <span style="color:#f92672">=</span> properties.ipConfigurations, nsg <span style="color:#f92672">=</span> properties.networkSecurityGroup
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> project nicId <span style="color:#f92672">=</span> tostring(id), subnetId <span style="color:#f92672">=</span> tostring(ipConfigurations.properties.subnet.id), nsgName<span style="color:#f92672">=</span>split(nsg.id, <span style="color:#e6db74">&#39;/&#39;</span>)[<span style="color:#ae81ff">8</span>]
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> parse kind<span style="color:#f92672">=</span>regex subnetId <span style="color:#66d9ef">with</span> <span style="color:#e6db74">&#39;/virtualNetworks/&#39;</span> virtualNetwork <span style="color:#e6db74">&#39;/subnets/&#39;</span> subnet
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> <span style="color:#66d9ef">join</span> kind<span style="color:#f92672">=</span><span style="color:#66d9ef">inner</span> (
</span></span><span style="display:flex;"><span>        Resources
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> <span style="color:#66d9ef">type</span> <span style="color:#f92672">=~</span> <span style="color:#e6db74">&#39;Microsoft.Network/NetworkSecurityGroups&#39;</span> <span style="color:#66d9ef">and</span> isnotnull(properties.subnets)
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">|</span> project name, resourceGroup, subnet<span style="color:#f92672">=</span>properties.subnets
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">|</span> mv<span style="color:#f92672">-</span>expand subnet
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">|</span> project subnetId<span style="color:#f92672">=</span>tostring(subnet.id)
</span></span><span style="display:flex;"><span>    ) <span style="color:#66d9ef">on</span> subnetId
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> project nicId
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#66d9ef">join</span> kind<span style="color:#f92672">=</span>leftouter (
</span></span><span style="display:flex;"><span>    Resources
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> <span style="color:#66d9ef">type</span> <span style="color:#f92672">=~</span> <span style="color:#e6db74">&#39;Microsoft.Compute/virtualMachines&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> isnotnull(properties.networkProfile.networkInterfaces)
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> mv<span style="color:#f92672">-</span>expand nic<span style="color:#f92672">=</span>properties.networkProfile.networkInterfaces
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> project vmName <span style="color:#f92672">=</span> name, vmId <span style="color:#f92672">=</span> id, tags, nicId <span style="color:#f92672">=</span> nic.id, nicName<span style="color:#f92672">=</span>split(nic.id, <span style="color:#e6db74">&#39;/&#39;</span>)[<span style="color:#ae81ff">8</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> extend nicId <span style="color:#f92672">=</span> tostring(nicId)
</span></span><span style="display:flex;"><span>) <span style="color:#66d9ef">on</span> nicId
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> project recommendationId <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;vm-13&#34;</span>, name<span style="color:#f92672">=</span>vmName, id <span style="color:#f92672">=</span> vmId, tags, param1 <span style="color:#f92672">=</span> strcat(<span style="color:#e6db74">&#34;nic-name=&#34;</span>, nicName)
</span></span></code></pre></div>
    </div>
</div>






  </div>
</div>
<p><br><br></p>
<h3 id="vm-14---ip-forwarding-should-only-be-enabled-for-network-virtual-appliances">VM-14 - IP Forwarding should only be enabled for Network Virtual Appliances
  <a href="#vm-14---ip-forwarding-should-only-be-enabled-for-network-virtual-appliances">
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-link" viewBox="0 0 16 16">
      <path d="M6.354 5.5H4a3 3 0 0 0 0 6h3a3 3 0 0 0 2.83-4H9c-.086 0-.17.01-.25.031A2 2 0 0 1 7 10.5H4a2 2 0 1 1 0-4h1.535c.218-.376.495-.714.82-1z"/>
      <path d="M9 5.5a3 3 0 0 0-2.83 4h1.098A2 2 0 0 1 9 6.5h3a2 2 0 1 1 0 4h-1.535a4.02 4.02 0 0 1-.82 1H12a3 3 0 1 0 0-6H9z"/>
    </svg>
  </a>
</h3>
<p><strong>Category: Access &amp; Security</strong></p>
<p><strong>Impact: Medium</strong></p>
<p><strong>Guidance</strong></p>
<p>IP forwarding enables the virtual machine network interface to:</p>
<p>Receive network traffic not destined for one of the IP addresses assigned to any of the IP configurations assigned to the network interface.</p>
<p>Send network traffic with a different source IP address than the one assigned to one of a network interface&rsquo;s IP configurations.</p>
<p>The setting must be enabled for every network interface that is attached to the virtual machine that receives traffic that the virtual machine needs to forward. A virtual machine can forward traffic whether it has multiple network interfaces or a single network interface attached to it. While IP forwarding is an Azure setting, the virtual machine must also run an application able to forward the traffic, such as firewall, WAN optimization, and load balancing applications.</p>
<p><strong>Resources</strong></p>
<ul>
<li><a href="https://learn.microsoft.com/azure/virtual-network/virtual-network-network-interface?tabs=network-interface-portal#enable-or-disable-ip-forwarding">Enable or disable IP forwarding</a></li>
</ul>
<p><strong>Resource Graph Query</strong></p>


<button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#collapse_a969f7cd4f" aria-expanded="false">
    Show/Hide Query/Script
</button>

<div class="collapse" id="collapse_a969f7cd4f">
  <div class="card card-body">
    







    
    




<div class="position-relative">
    <div class="position-absolute" style="right:0;">
        <button class="btn btn-light" data-clipboard-target="#clipboard_bab392a41b">
        Copy
        </button>
    </div>
    <div id="clipboard_bab392a41b">
    <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#f92672">//</span> Azure Resource Graph Query
</span></span><span style="display:flex;"><span><span style="color:#f92672">//</span> Find <span style="color:#66d9ef">all</span> VM NICs that have IPForwarding enabled. This feature <span style="color:#66d9ef">is</span> usually <span style="color:#66d9ef">only</span> required <span style="color:#66d9ef">for</span> Network Virtual Appliances
</span></span><span style="display:flex;"><span>Resources
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> <span style="color:#66d9ef">type</span> <span style="color:#f92672">=~</span> <span style="color:#e6db74">&#39;Microsoft.Compute/virtualMachines&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> isnotnull(properties.networkProfile.networkInterfaces)
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> mv<span style="color:#f92672">-</span>expand nic<span style="color:#f92672">=</span>properties.networkProfile.networkInterfaces
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> project name, id, tags, nicId <span style="color:#f92672">=</span> nic.id
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> extend nicId <span style="color:#f92672">=</span> tostring(nicId)
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#66d9ef">join</span> kind<span style="color:#f92672">=</span><span style="color:#66d9ef">inner</span> (
</span></span><span style="display:flex;"><span>    Resources
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> <span style="color:#66d9ef">type</span> <span style="color:#f92672">=~</span> <span style="color:#e6db74">&#39;Microsoft.Network/networkInterfaces&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> properties.enableIPForwarding <span style="color:#f92672">==</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> project nicId <span style="color:#f92672">=</span> tostring(id)
</span></span><span style="display:flex;"><span>) <span style="color:#66d9ef">on</span> nicId
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> project recommendationId <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;vm-14&#34;</span>, name, id, tags
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> id <span style="color:#66d9ef">asc</span>
</span></span></code></pre></div>
    </div>
</div>






  </div>
</div>
<p><br><br></p>
<h3 id="vm-15---customer-dns-servers-should-be-configured-in-the-virtual-network-level">VM-15 - Customer DNS Servers should be configured in the Virtual Network level
  <a href="#vm-15---customer-dns-servers-should-be-configured-in-the-virtual-network-level">
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-link" viewBox="0 0 16 16">
      <path d="M6.354 5.5H4a3 3 0 0 0 0 6h3a3 3 0 0 0 2.83-4H9c-.086 0-.17.01-.25.031A2 2 0 0 1 7 10.5H4a2 2 0 1 1 0-4h1.535c.218-.376.495-.714.82-1z"/>
      <path d="M9 5.5a3 3 0 0 0-2.83 4h1.098A2 2 0 0 1 9 6.5h3a2 2 0 1 1 0 4h-1.535a4.02 4.02 0 0 1-.82 1H12a3 3 0 1 0 0-6H9z"/>
    </svg>
  </a>
</h3>
<p><strong>Category: Storage</strong></p>
<p><strong>Impact: Low</strong></p>
<p><strong>Guidance</strong></p>
<p>Configure the DNS Server in the Virtual Network to avoid inconsistency across the environment.</p>
<p><strong>Resources</strong></p>
<ul>
<li><a href="https://learn.microsoft.com/azure/virtual-network/virtual-networks-name-resolution-for-vms-and-role-instances">Name resolution for resources in Azure virtual networks</a></li>
</ul>
<p><strong>Resource Graph Query</strong></p>


<button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#collapse_a58e98ceed" aria-expanded="false">
    Show/Hide Query/Script
</button>

<div class="collapse" id="collapse_a58e98ceed">
  <div class="card card-body">
    







    
    




<div class="position-relative">
    <div class="position-absolute" style="right:0;">
        <button class="btn btn-light" data-clipboard-target="#clipboard_258df60f9a">
        Copy
        </button>
    </div>
    <div id="clipboard_258df60f9a">
    <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#f92672">//</span> Azure Resource Graph Query
</span></span><span style="display:flex;"><span><span style="color:#f92672">//</span> Find <span style="color:#66d9ef">all</span> VM NICs that have DNS Server settings configured <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">any</span> <span style="color:#66d9ef">of</span> the NICs
</span></span><span style="display:flex;"><span>Resources
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> <span style="color:#66d9ef">type</span> <span style="color:#f92672">=~</span> <span style="color:#e6db74">&#39;Microsoft.Compute/virtualMachines&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> isnotnull(properties.networkProfile.networkInterfaces)
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> mv<span style="color:#f92672">-</span>expand nic<span style="color:#f92672">=</span>properties.networkProfile.networkInterfaces
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> project name, id, tags, nicId <span style="color:#f92672">=</span> nic.id
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> extend nicId <span style="color:#f92672">=</span> tostring(nicId)
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#66d9ef">join</span> kind<span style="color:#f92672">=</span><span style="color:#66d9ef">inner</span> (
</span></span><span style="display:flex;"><span>    Resources
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> <span style="color:#66d9ef">type</span> <span style="color:#f92672">=~</span> <span style="color:#e6db74">&#39;Microsoft.Network/networkInterfaces&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> project name, id, dnsServers <span style="color:#f92672">=</span> properties.dnsSettings.dnsServers
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> extend hasDns <span style="color:#f92672">=</span> array_length(dnsServers) <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> hasDns <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> project name, nicId <span style="color:#f92672">=</span> tostring(id)
</span></span><span style="display:flex;"><span>) <span style="color:#66d9ef">on</span> nicId
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> project recommendationId <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;vm-15&#34;</span>, name, id, tags
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> id <span style="color:#66d9ef">asc</span>
</span></span></code></pre></div>
    </div>
</div>






  </div>
</div>
<p><br><br></p>
<h3 id="vm-16---shared-disks-should-only-be-enabled-in-clustered-servers">VM-16 - Shared disks should only be enabled in clustered servers
  <a href="#vm-16---shared-disks-should-only-be-enabled-in-clustered-servers">
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-link" viewBox="0 0 16 16">
      <path d="M6.354 5.5H4a3 3 0 0 0 0 6h3a3 3 0 0 0 2.83-4H9c-.086 0-.17.01-.25.031A2 2 0 0 1 7 10.5H4a2 2 0 1 1 0-4h1.535c.218-.376.495-.714.82-1z"/>
      <path d="M9 5.5a3 3 0 0 0-2.83 4h1.098A2 2 0 0 1 9 6.5h3a2 2 0 1 1 0 4h-1.535a4.02 4.02 0 0 1-.82 1H12a3 3 0 1 0 0-6H9z"/>
    </svg>
  </a>
</h3>
<p><strong>Category: Storage</strong></p>
<p><strong>Impact: Medium</strong></p>
<p><strong>Guidance</strong></p>
<p>Azure shared disks is a feature for Azure managed disks that enables you to attach a managed disk to multiple virtual machines (VMs) simultaneously. Attaching a managed disk to multiple VMs allows you to either deploy new or migrate existing clustered applications to Azure, and should only be used in those situations where the disk will be assigned to more than one Virtual Machine member of a Cluster.</p>
<p><strong>Resources</strong></p>
<ul>
<li><a href="https://learn.microsoft.com/azure/virtual-machines/disks-shared-enable?tabs=azure-portal">Azure Shared Disks</a></li>
</ul>
<p><strong>Resource Graph Query</strong></p>


<button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#collapse_e4faa4e01d" aria-expanded="false">
    Show/Hide Query/Script
</button>

<div class="collapse" id="collapse_e4faa4e01d">
  <div class="card card-body">
    







    
    




<div class="position-relative">
    <div class="position-absolute" style="right:0;">
        <button class="btn btn-light" data-clipboard-target="#clipboard_184a542fd6">
        Copy
        </button>
    </div>
    <div id="clipboard_184a542fd6">
    <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#f92672">//</span> Azure Resource Graph Query
</span></span><span style="display:flex;"><span><span style="color:#f92672">//</span> Find <span style="color:#66d9ef">all</span> Disks configured <span style="color:#66d9ef">to</span> be Shared. This <span style="color:#66d9ef">is</span> <span style="color:#66d9ef">not</span> an indication <span style="color:#66d9ef">of</span> an issue, but <span style="color:#66d9ef">if</span> a disk <span style="color:#66d9ef">with</span> this configuration <span style="color:#66d9ef">is</span> assigned <span style="color:#66d9ef">to</span> two <span style="color:#66d9ef">or</span> <span style="color:#66d9ef">more</span> VMs <span style="color:#66d9ef">without</span> a proper disk control mechanism (<span style="color:#66d9ef">like</span> a WSFC) it can lead <span style="color:#66d9ef">to</span> <span style="color:#66d9ef">data</span> loss
</span></span><span style="display:flex;"><span>resources
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> <span style="color:#66d9ef">type</span> <span style="color:#f92672">=~</span> <span style="color:#e6db74">&#39;Microsoft.Compute/disks&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> isnotnull(properties.maxShares)
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> project id, name, tags, lowerCaseDiskId <span style="color:#f92672">=</span> tolower(id), diskState <span style="color:#f92672">=</span> tostring(properties.diskState)
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#66d9ef">join</span> kind <span style="color:#f92672">=</span> leftouter (
</span></span><span style="display:flex;"><span>    resources
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> <span style="color:#66d9ef">type</span> <span style="color:#f92672">=~</span> <span style="color:#e6db74">&#39;Microsoft.Compute/virtualMachines&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> project osDiskVmName <span style="color:#f92672">=</span> name, lowerCaseOsDiskId <span style="color:#f92672">=</span> tolower(properties.storageProfile.osDisk.managedDisk.id)
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> <span style="color:#66d9ef">join</span> kind <span style="color:#f92672">=</span> fullouter (
</span></span><span style="display:flex;"><span>        resources
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> <span style="color:#66d9ef">type</span> <span style="color:#f92672">=~</span> <span style="color:#e6db74">&#39;Microsoft.Compute/virtualMachines&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">|</span> mv<span style="color:#f92672">-</span>expand dataDisks <span style="color:#f92672">=</span> properties.storageProfile.dataDisks
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">|</span> project dataDiskVmName <span style="color:#f92672">=</span> name, lowerCaseDataDiskId <span style="color:#f92672">=</span> tolower(dataDisks.managedDisk.id)
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">on</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#66d9ef">left</span>.lowerCaseOsDiskId <span style="color:#f92672">==</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#66d9ef">right</span>.lowerCaseDataDiskId
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> project lowerCaseDiskId <span style="color:#f92672">=</span> coalesce(lowerCaseOsDiskId, lowerCaseDataDiskId), vmName <span style="color:#f92672">=</span> coalesce(osDiskVmName, dataDiskVmName)
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">on</span> lowerCaseDiskId
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> summarize vmNames <span style="color:#f92672">=</span> make_set(vmName) <span style="color:#66d9ef">by</span> name, id, tostring(tags), diskState
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> extend param1 <span style="color:#f92672">=</span> strcat(<span style="color:#e6db74">&#34;DiskState: &#34;</span>, diskState), param2 <span style="color:#f92672">=</span> iif(isempty(vmNames[<span style="color:#ae81ff">0</span>]), <span style="color:#e6db74">&#34;VMName: n/a&#34;</span>, strcat(<span style="color:#e6db74">&#34;VMName: &#34;</span>, strcat_array(vmNames, <span style="color:#e6db74">&#34;, &#34;</span>)))
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> project recommendationId <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;vm-16&#34;</span>, name, id, tags, param1, param2
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> id <span style="color:#66d9ef">asc</span>
</span></span></code></pre></div>
    </div>
</div>






  </div>
</div>
<p><br><br></p>
<h3 id="vm-17---network-access-to-the-vm-disk-should-be-set-to-disable-public-access-and-enable-private-access">VM-17 - Network access to the VM disk should be set to Disable public access and enable private access
  <a href="#vm-17---network-access-to-the-vm-disk-should-be-set-to-disable-public-access-and-enable-private-access">
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-link" viewBox="0 0 16 16">
      <path d="M6.354 5.5H4a3 3 0 0 0 0 6h3a3 3 0 0 0 2.83-4H9c-.086 0-.17.01-.25.031A2 2 0 0 1 7 10.5H4a2 2 0 1 1 0-4h1.535c.218-.376.495-.714.82-1z"/>
      <path d="M9 5.5a3 3 0 0 0-2.83 4h1.098A2 2 0 0 1 9 6.5h3a2 2 0 1 1 0 4h-1.535a4.02 4.02 0 0 1-.82 1H12a3 3 0 1 0 0-6H9z"/>
    </svg>
  </a>
</h3>
<p><strong>Category: Access &amp; Security</strong></p>
<p><strong>Impact: Low</strong></p>
<p><strong>Guidance</strong></p>
<p>Recommended changing to &ldquo;Disable public access and enable private access&rdquo; and creating a Private Endpoint</p>
<p><strong>Resources</strong></p>
<ul>
<li><a href="https://learn.microsoft.com/azure/virtual-machines/disks-enable-private-links-for-import-export-portal">Restrict import/export access for managed disks using Azure Private Link</a></li>
</ul>
<p><strong>Resource Graph Query</strong></p>


<button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#collapse_0800861007" aria-expanded="false">
    Show/Hide Query/Script
</button>

<div class="collapse" id="collapse_0800861007">
  <div class="card card-body">
    







    
    




<div class="position-relative">
    <div class="position-absolute" style="right:0;">
        <button class="btn btn-light" data-clipboard-target="#clipboard_b82d38f52c">
        Copy
        </button>
    </div>
    <div id="clipboard_b82d38f52c">
    <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#f92672">//</span> Azure Resource Graph Query
</span></span><span style="display:flex;"><span><span style="color:#f92672">//</span> Find <span style="color:#66d9ef">all</span> Disks <span style="color:#66d9ef">with</span> <span style="color:#e6db74">&#34;Enable public access from all networks&#34;</span> enabled
</span></span><span style="display:flex;"><span>resources
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> <span style="color:#66d9ef">type</span> <span style="color:#f92672">=~</span> <span style="color:#e6db74">&#39;Microsoft.Compute/disks&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> properties.publicNetworkAccess <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Enabled&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> project id, name, tags, lowerCaseDiskId <span style="color:#f92672">=</span> tolower(id)
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#66d9ef">join</span> kind <span style="color:#f92672">=</span> leftouter (
</span></span><span style="display:flex;"><span>    resources
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> <span style="color:#66d9ef">type</span> <span style="color:#f92672">=~</span> <span style="color:#e6db74">&#39;Microsoft.Compute/virtualMachines&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> project osDiskVmName <span style="color:#f92672">=</span> name, lowerCaseOsDiskId <span style="color:#f92672">=</span> tolower(properties.storageProfile.osDisk.managedDisk.id)
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> <span style="color:#66d9ef">join</span> kind <span style="color:#f92672">=</span> fullouter (
</span></span><span style="display:flex;"><span>        resources
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> <span style="color:#66d9ef">type</span> <span style="color:#f92672">=~</span> <span style="color:#e6db74">&#39;Microsoft.Compute/virtualMachines&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">|</span> mv<span style="color:#f92672">-</span>expand dataDisks <span style="color:#f92672">=</span> properties.storageProfile.dataDisks
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">|</span> project dataDiskVmName <span style="color:#f92672">=</span> name, lowerCaseDataDiskId <span style="color:#f92672">=</span> tolower(dataDisks.managedDisk.id)
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">on</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#66d9ef">left</span>.lowerCaseOsDiskId <span style="color:#f92672">==</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#66d9ef">right</span>.lowerCaseDataDiskId
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> project lowerCaseDiskId <span style="color:#f92672">=</span> coalesce(lowerCaseOsDiskId, lowerCaseDataDiskId), vmName <span style="color:#f92672">=</span> coalesce(osDiskVmName, dataDiskVmName)
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">on</span> lowerCaseDiskId
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> summarize vmNames <span style="color:#f92672">=</span> make_set(vmName) <span style="color:#66d9ef">by</span> name, id, tostring(tags)
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> extend param1 <span style="color:#f92672">=</span> iif(isempty(vmNames[<span style="color:#ae81ff">0</span>]), <span style="color:#e6db74">&#34;VMName: n/a&#34;</span>, strcat(<span style="color:#e6db74">&#34;VMName: &#34;</span>, strcat_array(vmNames, <span style="color:#e6db74">&#34;, &#34;</span>)))
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> project recommendationId <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;vm-17&#34;</span>, name, id, tags, param1
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> id <span style="color:#66d9ef">asc</span>
</span></span></code></pre></div>
    </div>
</div>






  </div>
</div>
<p><br><br></p>
<h3 id="vm-18---ensure-that-your-vms-are-compliant-with-azure-policies">VM-18 - Ensure that your VMs are compliant with Azure Policies
  <a href="#vm-18---ensure-that-your-vms-are-compliant-with-azure-policies">
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-link" viewBox="0 0 16 16">
      <path d="M6.354 5.5H4a3 3 0 0 0 0 6h3a3 3 0 0 0 2.83-4H9c-.086 0-.17.01-.25.031A2 2 0 0 1 7 10.5H4a2 2 0 1 1 0-4h1.535c.218-.376.495-.714.82-1z"/>
      <path d="M9 5.5a3 3 0 0 0-2.83 4h1.098A2 2 0 0 1 9 6.5h3a2 2 0 1 1 0 4h-1.535a4.02 4.02 0 0 1-.82 1H12a3 3 0 1 0 0-6H9z"/>
    </svg>
  </a>
</h3>
<p><strong>Category: Governance</strong></p>
<p><strong>Impact: Low</strong></p>
<p><strong>Guidance</strong></p>
<p>It&rsquo;s important to keep your virtual machine (VM) secure for the applications that you run. Securing your VMs can include one or more Azure services and features that cover secure access to your VMs and secure storage of your data. This article provides information that enables you to keep your VM and applications secure.</p>
<p><strong>Resources</strong></p>
<ul>
<li><a href="https://learn.microsoft.com/azure/cloud-adoption-framework/ready/landing-zone/design-principles#policy-driven-governance">Policy-driven governance</a></li>
<li><a href="https://learn.microsoft.com/azure/virtual-machines/security-policy">Azure Policy Regulatory Compliance controls for Azure Virtual Machines</a></li>
</ul>
<p><strong>Resource Graph Query</strong></p>


<button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#collapse_0199ee171f" aria-expanded="false">
    Show/Hide Query/Script
</button>

<div class="collapse" id="collapse_0199ee171f">
  <div class="card card-body">
    







    
    




<div class="position-relative">
    <div class="position-absolute" style="right:0;">
        <button class="btn btn-light" data-clipboard-target="#clipboard_8af3e8a78f">
        Copy
        </button>
    </div>
    <div id="clipboard_8af3e8a78f">
    <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#f92672">//</span> Azure Resource Graph Query
</span></span><span style="display:flex;"><span><span style="color:#f92672">//</span> Find <span style="color:#66d9ef">all</span> VMs <span style="color:#66d9ef">in</span> <span style="color:#e6db74">&#34;NonCompliant&#34;</span> <span style="color:#66d9ef">state</span> <span style="color:#66d9ef">with</span> Azure Policies
</span></span><span style="display:flex;"><span>PolicyResources
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> <span style="color:#66d9ef">type</span> <span style="color:#f92672">=~</span> <span style="color:#e6db74">&#34;Microsoft.PolicyInsights/policyStates&#34;</span> <span style="color:#66d9ef">and</span> properties.resourceType <span style="color:#f92672">=~</span> <span style="color:#e6db74">&#34;Microsoft.Compute/virtualMachines&#34;</span> <span style="color:#66d9ef">and</span> properties.complianceState <span style="color:#f92672">=~</span> <span style="color:#e6db74">&#34;NonCompliant&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> project
</span></span><span style="display:flex;"><span>    policyAssignmentName <span style="color:#f92672">=</span> properties.policyAssignmentName,
</span></span><span style="display:flex;"><span>    policyDefinitionName <span style="color:#f92672">=</span> properties.policyDefinitionName,
</span></span><span style="display:flex;"><span>    lowerCasePolicyDefinitionIdOfPolicyState <span style="color:#f92672">=</span> tolower(properties.policyDefinitionId),
</span></span><span style="display:flex;"><span>    lowerCaseVmIdOfPolicyState <span style="color:#f92672">=</span> tolower(properties.resourceId)
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#66d9ef">join</span> kind <span style="color:#f92672">=</span> leftouter (
</span></span><span style="display:flex;"><span>    PolicyResources
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> <span style="color:#66d9ef">type</span> <span style="color:#f92672">=~</span> <span style="color:#e6db74">&#34;Microsoft.Authorization/policyDefinitions&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> project lowerCasePolicyDefinitionId <span style="color:#f92672">=</span> tolower(id), policyDefinitionDisplayName <span style="color:#f92672">=</span> properties.displayName
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">on</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#66d9ef">left</span>.lowerCasePolicyDefinitionIdOfPolicyState <span style="color:#f92672">==</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#66d9ef">right</span>.lowerCasePolicyDefinitionId
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> project policyAssignmentName, policyDefinitionName, policyDefinitionDisplayName, lowerCaseVmIdOfPolicyState
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#66d9ef">join</span> kind <span style="color:#f92672">=</span> leftouter (
</span></span><span style="display:flex;"><span>    Resources
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> <span style="color:#66d9ef">type</span> <span style="color:#f92672">=~</span> <span style="color:#e6db74">&#34;Microsoft.Compute/virtualMachines&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> project vmName <span style="color:#f92672">=</span> name, vmId <span style="color:#f92672">=</span> id, vmTags <span style="color:#f92672">=</span> tags, lowerCaseVmId <span style="color:#f92672">=</span> tolower(id)
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">on</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#66d9ef">left</span>.lowerCaseVmIdOfPolicyState <span style="color:#f92672">==</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#66d9ef">right</span>.lowerCaseVmId
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> extend
</span></span><span style="display:flex;"><span>    param1 <span style="color:#f92672">=</span> strcat(<span style="color:#e6db74">&#34;AssignmentName: &#34;</span>, policyAssignmentName),
</span></span><span style="display:flex;"><span>    param2 <span style="color:#f92672">=</span> strcat(<span style="color:#e6db74">&#34;DefinitionName: &#34;</span>, policyDefinitionDisplayName),  <span style="color:#f92672">//</span> Align <span style="color:#66d9ef">to</span> Azure portal<span style="color:#e6db74">&#39;s term.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    param3 = strcat(&#34;DefinitionID: &#34;, policyDefinitionName)            // Align to Azure portal&#39;</span>s term.
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> project recommendationId <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;vm-18&#34;</span>, name <span style="color:#f92672">=</span> vmName, id <span style="color:#f92672">=</span> vmId, tags <span style="color:#f92672">=</span> vmTags, param1, param2, param3
</span></span></code></pre></div>
    </div>
</div>






  </div>
</div>
<p><br><br></p>
<h3 id="vm-19---enable-disk-encryption-and-data-at-rest-encryption-by-default">VM-19 - Enable disk encryption and data at rest encryption by default
  <a href="#vm-19---enable-disk-encryption-and-data-at-rest-encryption-by-default">
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-link" viewBox="0 0 16 16">
      <path d="M6.354 5.5H4a3 3 0 0 0 0 6h3a3 3 0 0 0 2.83-4H9c-.086 0-.17.01-.25.031A2 2 0 0 1 7 10.5H4a2 2 0 1 1 0-4h1.535c.218-.376.495-.714.82-1z"/>
      <path d="M9 5.5a3 3 0 0 0-2.83 4h1.098A2 2 0 0 1 9 6.5h3a2 2 0 1 1 0 4h-1.535a4.02 4.02 0 0 1-.82 1H12a3 3 0 1 0 0-6H9z"/>
    </svg>
  </a>
</h3>
<p><strong>Category: Access &amp; Security</strong></p>
<p><strong>Impact: Medium</strong></p>
<p><strong>Guidance</strong></p>
<p>There are several types of encryption available for your managed disks, including Azure Disk Encryption (ADE), Server-Side Encryption (SSE) and encryption at host.</p>
<ul>
<li>Azure Disk Encryption helps protect and safeguard your data to meet your organizational security and compliance commitments.</li>
<li>Azure Disk Storage Server-Side Encryption (also referred to as encryption-at-rest or Azure Storage encryption) automatically encrypts data stored on Azure managed disks (OS and data disks) when persisting on the Storage Clusters.</li>
<li>Encryption at host ensures that data stored on the VM host hosting your VM is encrypted at rest and flows encrypted to the Storage clusters.</li>
<li>Confidential disk encryption binds disk encryption keys to the virtual machine&rsquo;s TPM and makes the protected disk content accessible only to the VM.</li>
</ul>
<p><strong>Resources</strong></p>
<ul>
<li><a href="https://learn.microsoft.com/azure/virtual-machines/disk-encryption-overview">Overview of managed disk encryption options</a></li>
</ul>
<p><strong>Resource Graph Query</strong></p>


<button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#collapse_eb4611ac4f" aria-expanded="false">
    Show/Hide Query/Script
</button>

<div class="collapse" id="collapse_eb4611ac4f">
  <div class="card card-body">
    







    
    




<div class="position-relative">
    <div class="position-absolute" style="right:0;">
        <button class="btn btn-light" data-clipboard-target="#clipboard_1fb6cba347">
        Copy
        </button>
    </div>
    <div id="clipboard_1fb6cba347">
    <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#f92672">//</span> Azure Resource Graph Query
</span></span><span style="display:flex;"><span><span style="color:#f92672">//</span> Find <span style="color:#66d9ef">all</span> disks that <span style="color:#66d9ef">are</span> <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">encrypted</span>
</span></span><span style="display:flex;"><span>resources
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> <span style="color:#66d9ef">type</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;microsoft.compute/disks&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> extend encryptionType <span style="color:#f92672">=</span> properties.encryption.<span style="color:#66d9ef">type</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> extend diskState <span style="color:#f92672">=</span> properties.diskState
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> encryptionType <span style="color:#f92672">!</span><span style="color:#66d9ef">in</span> (<span style="color:#e6db74">&#34;EncryptionAtRestWithCustomerKey&#34;</span>, <span style="color:#e6db74">&#34;EncryptionAtRestWithPlatformAndCustomerKeys&#34;</span>, <span style="color:#e6db74">&#34;EncryptionAtRestWithPlatformKey&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> project recommendationId<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;vm-19&#34;</span>, name, id, tags, param1<span style="color:#f92672">=</span>strcat(<span style="color:#e6db74">&#34;encryptionType: &#34;</span> , properties.encryption.<span style="color:#66d9ef">type</span>), param2<span style="color:#f92672">=</span> strcat (<span style="color:#e6db74">&#34;diskstate: &#34;</span>, properties.diskState)
</span></span></code></pre></div>
    </div>
</div>






  </div>
</div>
<p><br><br></p>
<h3 id="vm-20---enable-vm-insights">VM-20 - Enable VM Insights
  <a href="#vm-20---enable-vm-insights">
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-link" viewBox="0 0 16 16">
      <path d="M6.354 5.5H4a3 3 0 0 0 0 6h3a3 3 0 0 0 2.83-4H9c-.086 0-.17.01-.25.031A2 2 0 0 1 7 10.5H4a2 2 0 1 1 0-4h1.535c.218-.376.495-.714.82-1z"/>
      <path d="M9 5.5a3 3 0 0 0-2.83 4h1.098A2 2 0 0 1 9 6.5h3a2 2 0 1 1 0 4h-1.535a4.02 4.02 0 0 1-.82 1H12a3 3 0 1 0 0-6H9z"/>
    </svg>
  </a>
</h3>
<p><strong>Category: Monitoring</strong></p>
<p><strong>Impact: Low</strong></p>
<p><strong>Guidance</strong></p>
<p>VM insights monitors the performance and health of your virtual machines and virtual machine scale sets. It monitors their running processes and dependencies on other resources. VM insights can help deliver predictable performance and availability of vital applications by identifying performance bottlenecks and network issues. It can also help you understand whether an issue is related to other dependencies.</p>
<p><strong>Resources</strong></p>
<ul>
<li><a href="https://learn.microsoft.com/azure/azure-monitor/vm/vminsights-overview">Overview of VM insights</a></li>
<li><a href="https://learn.microsoft.com/azure/azure-monitor/vm/vminsights-troubleshoot#did-the-extension-install-properly">Did the extension install properly?</a></li>
</ul>
<p><strong>Resource Graph Query</strong></p>


<button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#collapse_d902b06591" aria-expanded="false">
    Show/Hide Query/Script
</button>

<div class="collapse" id="collapse_d902b06591">
  <div class="card card-body">
    







    
    




<div class="position-relative">
    <div class="position-absolute" style="right:0;">
        <button class="btn btn-light" data-clipboard-target="#clipboard_ca540fbe5b">
        Copy
        </button>
    </div>
    <div id="clipboard_ca540fbe5b">
    <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#f92672">//</span> Azure Resource Graph Query
</span></span><span style="display:flex;"><span><span style="color:#f92672">//</span> <span style="color:#66d9ef">Check</span> <span style="color:#66d9ef">for</span> VMs <span style="color:#66d9ef">without</span> Azure Monitoring Agent extension installed, missing <span style="color:#66d9ef">Data</span> Collection <span style="color:#66d9ef">Rule</span> <span style="color:#66d9ef">or</span> <span style="color:#66d9ef">Data</span> Collection <span style="color:#66d9ef">Rule</span> <span style="color:#66d9ef">without</span> performance enabled.
</span></span><span style="display:flex;"><span>Resources
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> <span style="color:#66d9ef">type</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;microsoft.compute/virtualmachines&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> project idVm <span style="color:#f92672">=</span> tolower(id), name, tags
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#66d9ef">join</span> kind<span style="color:#f92672">=</span>leftouter (
</span></span><span style="display:flex;"><span>    InsightsResources
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> <span style="color:#66d9ef">type</span> <span style="color:#f92672">=~</span> <span style="color:#e6db74">&#34;Microsoft.Insights/dataCollectionRuleAssociations&#34;</span> <span style="color:#66d9ef">and</span> id has <span style="color:#e6db74">&#34;Microsoft.Compute/virtualMachines&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> project idDcr <span style="color:#f92672">=</span> tolower(properties.dataCollectionRuleId), idVmDcr <span style="color:#f92672">=</span> tolower(<span style="color:#66d9ef">substring</span>(id, <span style="color:#ae81ff">0</span>, indexof(id, <span style="color:#e6db74">&#34;/providers/Microsoft.Insights/dataCollectionRuleAssociations/&#34;</span>))))
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">on</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#66d9ef">left</span>.idVm <span style="color:#f92672">==</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#66d9ef">right</span>.idVmDcr
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#66d9ef">join</span> kind<span style="color:#f92672">=</span>leftouter (
</span></span><span style="display:flex;"><span>    Resources
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> <span style="color:#66d9ef">type</span> <span style="color:#f92672">=~</span> <span style="color:#e6db74">&#34;Microsoft.Insights/dataCollectionRules&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> extend
</span></span><span style="display:flex;"><span>        isPerformanceEnabled <span style="color:#f92672">=</span> iif(properties.dataSources.performanceCounters <span style="color:#66d9ef">contains</span> <span style="color:#e6db74">&#34;Microsoft-InsightsMetrics&#34;</span> <span style="color:#66d9ef">and</span> properties.dataFlows <span style="color:#66d9ef">contains</span> <span style="color:#e6db74">&#34;Microsoft-InsightsMetrics&#34;</span>, <span style="color:#66d9ef">true</span>, <span style="color:#66d9ef">false</span>),
</span></span><span style="display:flex;"><span>        isMapEnabled <span style="color:#f92672">=</span> iif(properties.dataSources.extensions <span style="color:#66d9ef">contains</span> <span style="color:#e6db74">&#34;Microsoft-ServiceMap&#34;</span> <span style="color:#66d9ef">and</span> properties.dataSources.extensions <span style="color:#66d9ef">contains</span> <span style="color:#e6db74">&#34;DependencyAgent&#34;</span> <span style="color:#66d9ef">and</span> properties.dataFlows <span style="color:#66d9ef">contains</span> <span style="color:#e6db74">&#34;Microsoft-ServiceMap&#34;</span>, <span style="color:#66d9ef">true</span>, <span style="color:#66d9ef">false</span>)<span style="color:#f92672">//</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> isPerformanceEnabled <span style="color:#66d9ef">or</span> isMapEnabled
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> project dcrName <span style="color:#f92672">=</span> name, isPerformanceEnabled, isMapEnabled, idDcr <span style="color:#f92672">=</span> tolower(id))
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">on</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#66d9ef">left</span>.idDcr <span style="color:#f92672">==</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#66d9ef">right</span>.idDcr
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#66d9ef">join</span> kind<span style="color:#f92672">=</span>leftouter (
</span></span><span style="display:flex;"><span>    Resources
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> <span style="color:#66d9ef">type</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;microsoft.compute/virtualmachines/extensions&#39;</span> <span style="color:#66d9ef">and</span> (name <span style="color:#66d9ef">contains</span> <span style="color:#e6db74">&#39;AzureMonitorWindowsAgent&#39;</span> <span style="color:#66d9ef">or</span> name <span style="color:#66d9ef">contains</span> <span style="color:#e6db74">&#39;AzureMonitorLinuxAgent&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">|</span> extend idVmExtension <span style="color:#f92672">=</span> tolower(<span style="color:#66d9ef">substring</span>(id, <span style="color:#ae81ff">0</span>, indexof(id, <span style="color:#e6db74">&#39;/extensions&#39;</span>))), extensionName <span style="color:#f92672">=</span> name)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">on</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#66d9ef">left</span>.idVm <span style="color:#f92672">==</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#66d9ef">right</span>.idVmExtension
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> isPerformanceEnabled <span style="color:#f92672">!=</span> <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">or</span> (extensionName <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;AzureMonitorWindowsAgent&#39;</span> <span style="color:#66d9ef">and</span> extensionName <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;AzureMonitorLinuxAgent&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> project recommendationId <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;vm-20&#34;</span>, name, id <span style="color:#f92672">=</span> idVm, tags, param1 <span style="color:#f92672">=</span> strcat(<span style="color:#e6db74">&#39;MonitoringExtension:&#39;</span>, extensionName), param2 <span style="color:#f92672">=</span> strcat(<span style="color:#e6db74">&#39;DataCollectionRuleId:&#39;</span>, idDcr), param3 <span style="color:#f92672">=</span> strcat(<span style="color:#e6db74">&#39;isPerformanceEnabled:&#39;</span>, isPerformanceEnabled)
</span></span></code></pre></div>
    </div>
</div>






  </div>
</div>
<p><br><br></p>
<h3 id="vm-21---configure-diagnostic-settings-for-all-azure-virtual-machines">VM-21 - Configure diagnostic settings for all Azure Virtual Machines
  <a href="#vm-21---configure-diagnostic-settings-for-all-azure-virtual-machines">
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-link" viewBox="0 0 16 16">
      <path d="M6.354 5.5H4a3 3 0 0 0 0 6h3a3 3 0 0 0 2.83-4H9c-.086 0-.17.01-.25.031A2 2 0 0 1 7 10.5H4a2 2 0 1 1 0-4h1.535c.218-.376.495-.714.82-1z"/>
      <path d="M9 5.5a3 3 0 0 0-2.83 4h1.098A2 2 0 0 1 9 6.5h3a2 2 0 1 1 0 4h-1.535a4.02 4.02 0 0 1-.82 1H12a3 3 0 1 0 0-6H9z"/>
    </svg>
  </a>
</h3>
<p><strong>Category: Monitoring</strong></p>
<p><strong>Impact: Low</strong></p>
<p><strong>Guidance</strong></p>
<p>Platform metrics are sent automatically to Azure Monitor Metrics by default and without configuration.
Platform logs provide detailed diagnostic and auditing information for Azure resources and the Azure platform they depend on:</p>
<ul>
<li>Resource logs aren&rsquo;t collected until they&rsquo;re routed to a destination.</li>
<li>Activity logs exist on their own but can be routed to other locations.</li>
</ul>
<p>Each Azure resource requires its own diagnostic setting, which defines the following criteria:</p>
<ul>
<li>Sources: The type of metric and log data to send to the destinations defined in the setting. The available types vary by resource type.</li>
<li>Destinations: One or more destinations to send to.</li>
</ul>
<p>A single diagnostic setting can define no more than one of each of the destinations. If you want to send data to more than one of a particular destination type (for example, two different Log Analytics workspaces), create multiple settings. Each resource can have up to five diagnostic settings.</p>
<p><strong>Resources</strong></p>
<ul>
<li><a href="https://learn.microsoft.com/azure/azure-monitor/essentials/diagnostic-settings?tabs=portal">Diagnostic settings in Azure Monitor</a></li>
</ul>
<p><strong>Resource Graph Query</strong></p>


<button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#collapse_b9e8f9b9ae" aria-expanded="false">
    Show/Hide Query/Script
</button>

<div class="collapse" id="collapse_b9e8f9b9ae">
  <div class="card card-body">
    







    
    




<div class="position-relative">
    <div class="position-absolute" style="right:0;">
        <button class="btn btn-light" data-clipboard-target="#clipboard_b86b395b20">
        Copy
        </button>
    </div>
    <div id="clipboard_b86b395b20">
    <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#f92672">//</span> Azure Resource Graph Query
</span></span><span style="display:flex;"><span><span style="color:#f92672">//</span> Find <span style="color:#66d9ef">all</span> Virtual Machines <span style="color:#66d9ef">without</span> diagnostic settings enabled<span style="color:#f92672">/</span><span style="color:#66d9ef">with</span> diagnostic settings enabled but <span style="color:#66d9ef">not</span> configured <span style="color:#66d9ef">both</span> performance counters <span style="color:#66d9ef">and</span> event logs<span style="color:#f92672">/</span>syslogs.
</span></span><span style="display:flex;"><span>resources
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> <span style="color:#66d9ef">type</span> <span style="color:#f92672">=~</span> <span style="color:#e6db74">&#34;microsoft.compute/virtualmachines&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> project name, id, tags, lowerCaseVmId <span style="color:#f92672">=</span> tolower(id)
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#66d9ef">join</span> kind <span style="color:#f92672">=</span> leftouter (
</span></span><span style="display:flex;"><span>    resources
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> <span style="color:#66d9ef">type</span> <span style="color:#f92672">=~</span> <span style="color:#e6db74">&#34;Microsoft.Compute/virtualMachines/extensions&#34;</span> <span style="color:#66d9ef">and</span> properties.publisher <span style="color:#f92672">=~</span> <span style="color:#e6db74">&#34;Microsoft.Azure.Diagnostics&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> project
</span></span><span style="display:flex;"><span>        lowerCaseVmIdOfExtension <span style="color:#f92672">=</span> tolower(<span style="color:#66d9ef">substring</span>(id, <span style="color:#ae81ff">0</span>, indexof(id, <span style="color:#e6db74">&#34;/extensions/&#34;</span>))),
</span></span><span style="display:flex;"><span>        extensionType <span style="color:#f92672">=</span> properties.<span style="color:#66d9ef">type</span>,
</span></span><span style="display:flex;"><span>        provisioningState <span style="color:#f92672">=</span> properties.provisioningState,
</span></span><span style="display:flex;"><span>        storageAccount <span style="color:#f92672">=</span> properties.settings.StorageAccount,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">//</span> Windows
</span></span><span style="display:flex;"><span>        wadPerfCounters <span style="color:#f92672">=</span> properties.settings.WadCfg.DiagnosticMonitorConfiguration.PerformanceCounters.PerformanceCounterConfiguration,
</span></span><span style="display:flex;"><span>        wadEventLogs <span style="color:#f92672">=</span> properties.settings.WadCfg.DiagnosticMonitorConfiguration.WindowsEventLog,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">//</span> Linux
</span></span><span style="display:flex;"><span>        ladPerfCounters <span style="color:#f92672">=</span> properties.settings.ladCfg.diagnosticMonitorConfiguration.performanceCounters.performanceCounterConfiguration,
</span></span><span style="display:flex;"><span>        ladSyslog <span style="color:#f92672">=</span> properties.settings.ladCfg.diagnosticMonitorConfiguration.syslogEvents
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> extend
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">//</span> Windows
</span></span><span style="display:flex;"><span>        isWadPerfCountersConfigured <span style="color:#f92672">=</span> iif(array_length(wadPerfCounters) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">true</span>, <span style="color:#66d9ef">false</span>),
</span></span><span style="display:flex;"><span>        isWadEventLogsConfigured <span style="color:#f92672">=</span> iif(isnotnull(wadEventLogs) <span style="color:#66d9ef">and</span> array_length(wadEventLogs.DataSource) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">true</span>, <span style="color:#66d9ef">false</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">//</span> Linux
</span></span><span style="display:flex;"><span>        isLadPerfCountersConfigured <span style="color:#f92672">=</span> iif(array_length(ladPerfCounters) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">true</span>, <span style="color:#66d9ef">false</span>),
</span></span><span style="display:flex;"><span>        isLadSyslogConfigured <span style="color:#f92672">=</span> isnotnull(ladSyslog)
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> project
</span></span><span style="display:flex;"><span>        lowerCaseVmIdOfExtension,
</span></span><span style="display:flex;"><span>        extensionType,
</span></span><span style="display:flex;"><span>        provisioningState,
</span></span><span style="display:flex;"><span>        storageAccount,
</span></span><span style="display:flex;"><span>        isPerfCountersConfigured <span style="color:#f92672">=</span> <span style="color:#66d9ef">case</span>(extensionType <span style="color:#f92672">=~</span> <span style="color:#e6db74">&#34;IaaSDiagnostics&#34;</span>, isWadPerfCountersConfigured, extensionType <span style="color:#f92672">=~</span> <span style="color:#e6db74">&#34;LinuxDiagnostic&#34;</span>, isLadPerfCountersConfigured, <span style="color:#66d9ef">false</span>),
</span></span><span style="display:flex;"><span>        isEventLogsConfigured <span style="color:#f92672">=</span> <span style="color:#66d9ef">case</span>(extensionType <span style="color:#f92672">=~</span> <span style="color:#e6db74">&#34;IaaSDiagnostics&#34;</span>, isWadEventLogsConfigured, extensionType <span style="color:#f92672">=~</span> <span style="color:#e6db74">&#34;LinuxDiagnostic&#34;</span>, isLadSyslogConfigured, <span style="color:#66d9ef">false</span>)
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">on</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#66d9ef">left</span>.lowerCaseVmId <span style="color:#f92672">==</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#66d9ef">right</span>.lowerCaseVmIdOfExtension
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> isempty(lowerCaseVmIdOfExtension) <span style="color:#66d9ef">or</span> provisioningState <span style="color:#f92672">!~</span> <span style="color:#e6db74">&#34;Succeeded&#34;</span> <span style="color:#66d9ef">or</span> <span style="color:#66d9ef">not</span>(isPerfCountersConfigured <span style="color:#66d9ef">and</span> isEventLogsConfigured)
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> extend
</span></span><span style="display:flex;"><span>    param1 <span style="color:#f92672">=</span> strcat(<span style="color:#e6db74">&#34;DiagnosticSetting: &#34;</span>, iif(isnotnull(extensionType), strcat(<span style="color:#e6db74">&#34;Enabled, partially configured (&#34;</span>, extensionType, <span style="color:#e6db74">&#34;)&#34;</span>), <span style="color:#e6db74">&#34;Not enabled&#34;</span>)),
</span></span><span style="display:flex;"><span>    param2 <span style="color:#f92672">=</span> strcat(<span style="color:#e6db74">&#34;ProvisioningState: &#34;</span>, iif(isnotnull(provisioningState), provisioningState, <span style="color:#e6db74">&#34;n/a&#34;</span>)),
</span></span><span style="display:flex;"><span>    param3 <span style="color:#f92672">=</span> strcat(<span style="color:#e6db74">&#34;storageAccount: &#34;</span>, iif(isnotnull(storageAccount), storageAccount, <span style="color:#e6db74">&#34;n/a&#34;</span>)),
</span></span><span style="display:flex;"><span>    param4 <span style="color:#f92672">=</span> strcat(<span style="color:#e6db74">&#34;PerformanceCounters: &#34;</span>, <span style="color:#66d9ef">case</span>(<span style="color:#66d9ef">isnull</span>(isPerfCountersConfigured), <span style="color:#e6db74">&#34;n/a&#34;</span>, isPerfCountersConfigured, <span style="color:#e6db74">&#34;Configured&#34;</span>, <span style="color:#e6db74">&#34;Not configured&#34;</span>)),
</span></span><span style="display:flex;"><span>    param5 <span style="color:#f92672">=</span> strcat(<span style="color:#e6db74">&#34;EventLogs/Syslogs: &#34;</span>, <span style="color:#66d9ef">case</span>(<span style="color:#66d9ef">isnull</span>(isEventLogsConfigured), <span style="color:#e6db74">&#34;n/a&#34;</span>, isEventLogsConfigured, <span style="color:#e6db74">&#34;Configured&#34;</span>, <span style="color:#e6db74">&#34;Not configured&#34;</span>))
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> project recommendationId <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;vm-21&#34;</span>, name, id, tags, param1, param2, param3, param4, param5
</span></span></code></pre></div>
    </div>
</div>






  </div>
</div>
<p><br><br></p>
<h3 id="vm-22---use-maintenance-configurations-for-the-vms">VM-22 - Use maintenance configurations for the VMs
  <a href="#vm-22---use-maintenance-configurations-for-the-vms">
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-link" viewBox="0 0 16 16">
      <path d="M6.354 5.5H4a3 3 0 0 0 0 6h3a3 3 0 0 0 2.83-4H9c-.086 0-.17.01-.25.031A2 2 0 0 1 7 10.5H4a2 2 0 1 1 0-4h1.535c.218-.376.495-.714.82-1z"/>
      <path d="M9 5.5a3 3 0 0 0-2.83 4h1.098A2 2 0 0 1 9 6.5h3a2 2 0 1 1 0 4h-1.535a4.02 4.02 0 0 1-.82 1H12a3 3 0 1 0 0-6H9z"/>
    </svg>
  </a>
</h3>
<p><strong>Category: Governance</strong></p>
<p><strong>Impact: High</strong></p>
<p><strong>Guidance</strong></p>
<p>The maintenance configuration settings allows user to schedule and manage updates, ensuring the VM updates/interruptions are done in planned timeframe.</p>
<p><strong>Resources</strong></p>
<ul>
<li><a href="https://learn.microsoft.com/azure/virtual-machines/maintenance-configurations">Use maintenance configurations to control and manage the VM updates</a></li>
</ul>
<p><strong>Resource Graph Query</strong></p>


<button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#collapse_da5ceb2279" aria-expanded="false">
    Show/Hide Query/Script
</button>

<div class="collapse" id="collapse_da5ceb2279">
  <div class="card card-body">
    







    
    




<div class="position-relative">
    <div class="position-absolute" style="right:0;">
        <button class="btn btn-light" data-clipboard-target="#clipboard_86e18d07e8">
        Copy
        </button>
    </div>
    <div id="clipboard_86e18d07e8">
    <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#f92672">//</span> Azure Resource Graph Query
</span></span><span style="display:flex;"><span><span style="color:#f92672">//</span> Find VMS that <span style="color:#66d9ef">do</span> <span style="color:#66d9ef">not</span> have maintenance configuration assigned
</span></span><span style="display:flex;"><span>Resources
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> extend resourceId <span style="color:#f92672">=</span> tolower(id)
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> project name, <span style="color:#66d9ef">location</span>, <span style="color:#66d9ef">type</span>, id, tags, resourceId, properties
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> <span style="color:#66d9ef">type</span> <span style="color:#f92672">=~</span> <span style="color:#e6db74">&#39;Microsoft.Compute/virtualMachines&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#66d9ef">join</span> kind<span style="color:#f92672">=</span>leftouter (
</span></span><span style="display:flex;"><span>maintenanceresources
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> <span style="color:#66d9ef">type</span> <span style="color:#f92672">=~</span> <span style="color:#e6db74">&#34;microsoft.maintenance/configurationassignments&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> project planName <span style="color:#f92672">=</span> name, <span style="color:#66d9ef">type</span>, maintenanceProps <span style="color:#f92672">=</span> properties
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> extend resourceId <span style="color:#f92672">=</span> tostring(maintenanceProps.resourceId)
</span></span><span style="display:flex;"><span>) <span style="color:#66d9ef">on</span> resourceId
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> <span style="color:#66d9ef">isnull</span>(maintenanceProps)
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> project recommendationId <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;vm-22&#34;</span>,name, id, tags
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#66d9ef">order</span> <span style="color:#66d9ef">by</span> id <span style="color:#66d9ef">asc</span>
</span></span></code></pre></div>
    </div>
</div>






  </div>
</div>
<p><br><br></p>
<h3 id="vm-23---avoid-using-a-or-b-series-vm-sku-for-production-vms-that-need-the-full-performance-of-the-cpu-continuously">VM-23 - Avoid using A or B-Series VM Sku for production VMs that need the full performance of the CPU continuously
  <a href="#vm-23---avoid-using-a-or-b-series-vm-sku-for-production-vms-that-need-the-full-performance-of-the-cpu-continuously">
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-link" viewBox="0 0 16 16">
      <path d="M6.354 5.5H4a3 3 0 0 0 0 6h3a3 3 0 0 0 2.83-4H9c-.086 0-.17.01-.25.031A2 2 0 0 1 7 10.5H4a2 2 0 1 1 0-4h1.535c.218-.376.495-.714.82-1z"/>
      <path d="M9 5.5a3 3 0 0 0-2.83 4h1.098A2 2 0 0 1 9 6.5h3a2 2 0 1 1 0 4h-1.535a4.02 4.02 0 0 1-.82 1H12a3 3 0 1 0 0-6H9z"/>
    </svg>
  </a>
</h3>
<p><strong>Category: System Efficiency</strong></p>
<p><strong>Impact: High</strong></p>
<p><strong>Guidance</strong></p>
<p>A-series VMs have CPU performance and memory configurations best suited for entry level workloads like development and test. Some example use cases include development and test servers, low traffic web servers, small to medium databases, proof-of-concepts, and code repositories.</p>
<p>B-series VMs are ideal for workloads that do not need the full performance of the CPU continuously, like web servers, proof of concepts, small databases and development build environments. These workloads typically have burstable performance requirements. To determine the physical hardware on which this size is deployed, query the virtual hardware from within the virtual machine. The B-series provides you with the ability to purchase a VM size with baseline performance that can build up credits when it is using less than its baseline. When the VM has accumulated credits, the VM can burst above the baseline using up to 100% of the vCPU when your application requires higher CPU performance. Upon consuming all the CPU credits, a B-series virtual machine is throttled back to its base CPU performance until it accumulates the credits to CPU burst again.</p>
<p><strong>Resources</strong></p>
<ul>
<li><a href="https://learn.microsoft.com/en-us/azure/virtual-machines/sizes-b-series-burstable">B-series burstable virtual machine sizes</a></li>
</ul>
<p><strong>Resource Graph Query</strong></p>


<button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#collapse_8aa2f1b203" aria-expanded="false">
    Show/Hide Query/Script
</button>

<div class="collapse" id="collapse_8aa2f1b203">
  <div class="card card-body">
    







    
    




<div class="position-relative">
    <div class="position-absolute" style="right:0;">
        <button class="btn btn-light" data-clipboard-target="#clipboard_d992a197a3">
        Copy
        </button>
    </div>
    <div id="clipboard_d992a197a3">
    <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#f92672">//</span> Azure Resource Graph Query
</span></span><span style="display:flex;"><span><span style="color:#f92672">//</span> Find <span style="color:#66d9ef">all</span> VMs <span style="color:#66d9ef">using</span> A <span style="color:#66d9ef">or</span> B series families
</span></span><span style="display:flex;"><span>resources
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> <span style="color:#66d9ef">type</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;microsoft.compute/virtualmachines&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> properties.hardwareProfile.vmSize <span style="color:#66d9ef">contains</span> <span style="color:#e6db74">&#34;Standard_B&#34;</span> <span style="color:#66d9ef">or</span> properties.hardwareProfile.vmSize <span style="color:#66d9ef">contains</span> <span style="color:#e6db74">&#34;Standard_A&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> project recommendationId <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;vm-23&#34;</span>, name, id, tags, param1<span style="color:#f92672">=</span>strcat(<span style="color:#e6db74">&#34;vmSku: &#34;</span> , properties.hardwareProfile.vmSize)
</span></span></code></pre></div>
    </div>
</div>






  </div>
</div>
<p><br><br></p>
<h3 id="vm-24---mission-critical-workloads-should-be-using-premium-or-ultra-disks">VM-24 - Mission Critical Workloads should be using Premium or Ultra Disks
  <a href="#vm-24---mission-critical-workloads-should-be-using-premium-or-ultra-disks">
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-link" viewBox="0 0 16 16">
      <path d="M6.354 5.5H4a3 3 0 0 0 0 6h3a3 3 0 0 0 2.83-4H9c-.086 0-.17.01-.25.031A2 2 0 0 1 7 10.5H4a2 2 0 1 1 0-4h1.535c.218-.376.495-.714.82-1z"/>
      <path d="M9 5.5a3 3 0 0 0-2.83 4h1.098A2 2 0 0 1 9 6.5h3a2 2 0 1 1 0 4h-1.535a4.02 4.02 0 0 1-.82 1H12a3 3 0 1 0 0-6H9z"/>
    </svg>
  </a>
</h3>
<p><strong>Category: System Efficiency</strong></p>
<p><strong>Impact: High</strong></p>
<p><strong>Guidance</strong></p>
<p>Azure Premium SSDs deliver high-performance and low-latency disk support for virtual machines (VMs) with input/output (IO)-intensive workloads.</p>
<p>Premium SSD v2 offers higher performance than Premium SSDs while also generally being less costly. You can individually tweak the performance (capacity, throughput, and IOPS) of Premium SSD v2 disks at any time, allowing workloads to be cost efficient while meeting shifting performance needs. You should use Premium solid-state drives (SSDs) as operating system (OS) disks as the V2 is not supported as OS Disk.</p>
<p>Azure ultra disks are the highest-performing storage option for Azure virtual machines (VMs). You can change the performance parameters of an ultra disk without having to restart your VMs. Ultra disks are suited for data-intensive workloads such as SAP HANA, top-tier databases, and transaction-heavy workloads. Ultra disks must be used as data disks and can only be created as empty disks. You should use Premium solid-state drives (SSDs) as operating system (OS) disks.</p>
<p><strong>Resources</strong></p>
<ul>
<li><a href="https://learn.microsoft.com/en-us/azure/virtual-machines/disks-types#disk-type-comparison">Disk type comparison and decision tree</a></li>
</ul>
<p><strong>Resource Graph Query</strong></p>


<button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#collapse_ba9b1d6426" aria-expanded="false">
    Show/Hide Query/Script
</button>

<div class="collapse" id="collapse_ba9b1d6426">
  <div class="card card-body">
    







    
    




<div class="position-relative">
    <div class="position-absolute" style="right:0;">
        <button class="btn btn-light" data-clipboard-target="#clipboard_d94d0aca39">
        Copy
        </button>
    </div>
    <div id="clipboard_d94d0aca39">
    <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#f92672">//</span> Azure Resource Graph Query
</span></span><span style="display:flex;"><span><span style="color:#f92672">//</span> Find <span style="color:#66d9ef">all</span> VMs that have an attached disk that <span style="color:#66d9ef">is</span> <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">in</span> the Premium <span style="color:#66d9ef">or</span> Ultra sku tier.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>resources
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> <span style="color:#66d9ef">type</span> <span style="color:#f92672">=~</span> <span style="color:#e6db74">&#39;Microsoft.Compute/virtualMachines&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> extend lname <span style="color:#f92672">=</span> tolower(name)
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#66d9ef">join</span> kind<span style="color:#f92672">=</span>leftouter(resources
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> <span style="color:#66d9ef">type</span> <span style="color:#f92672">=~</span> <span style="color:#e6db74">&#39;Microsoft.Compute/disks&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> <span style="color:#66d9ef">not</span>(sku.tier <span style="color:#f92672">=~</span> <span style="color:#e6db74">&#39;Premium&#39;</span>) <span style="color:#66d9ef">and</span> <span style="color:#66d9ef">not</span>(sku.tier <span style="color:#f92672">=~</span> <span style="color:#e6db74">&#39;Ultra&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> extend lname <span style="color:#f92672">=</span> tolower(tostring(split(managedBy, <span style="color:#e6db74">&#39;/&#39;</span>)[<span style="color:#ae81ff">8</span>]))
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> project lname, name
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> summarize disks <span style="color:#f92672">=</span> make_list(name) <span style="color:#66d9ef">by</span> lname) <span style="color:#66d9ef">on</span> lname
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#66d9ef">where</span> isnotnull(disks)
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> project recommendationId <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;vm-24&#34;</span>, name, id, tags, param1<span style="color:#f92672">=</span>strcat(<span style="color:#e6db74">&#34;AffectedDisks: &#34;</span>, disks)
</span></span></code></pre></div>
    </div>
</div>






  </div>
</div>
<p><br><br></p>
<h3 id="vm-26---ensure-all-vms-part-of-a-sql-always-on-cluster-have-the-same-specifications-and-configurations">VM-26 - Ensure all VMs part of a SQL Always-on cluster have the same specifications and configurations
  <a href="#vm-26---ensure-all-vms-part-of-a-sql-always-on-cluster-have-the-same-specifications-and-configurations">
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-link" viewBox="0 0 16 16">
      <path d="M6.354 5.5H4a3 3 0 0 0 0 6h3a3 3 0 0 0 2.83-4H9c-.086 0-.17.01-.25.031A2 2 0 0 1 7 10.5H4a2 2 0 1 1 0-4h1.535c.218-.376.495-.714.82-1z"/>
      <path d="M9 5.5a3 3 0 0 0-2.83 4h1.098A2 2 0 0 1 9 6.5h3a2 2 0 1 1 0 4h-1.535a4.02 4.02 0 0 1-.82 1H12a3 3 0 1 0 0-6H9z"/>
    </svg>
  </a>
</h3>
<p><strong>Category: Availability</strong></p>
<p><strong>Impact: High</strong></p>
<p><strong>Guidance</strong></p>
<p>All VMs that are members or a SQL Always-on cluster must use the same VM Sku, same number of data disks, same disks Skus, same number of Network Interfaces, same VM Extensions, etc.</p>
<p><strong>Resources</strong></p>
<ul>
<li><a href="https://learn.microsoft.com/en-us/sql/database-engine/availability-groups/windows/prereqs-restrictions-recommendations-always-on-availability?view=sql-server-ver16">Prerequisites, restrictions, and recommendations for Always On availability groups</a></li>
</ul>
<p><strong>Resource Graph Query</strong></p>


<button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#collapse_481d94be0d" aria-expanded="false">
    Show/Hide Query/Script
</button>

<div class="collapse" id="collapse_481d94be0d">
  <div class="card card-body">
    







    
    




<div class="position-relative">
    <div class="position-absolute" style="right:0;">
        <button class="btn btn-light" data-clipboard-target="#clipboard_b581ba5583">
        Copy
        </button>
    </div>
    <div id="clipboard_b581ba5583">
    <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#f92672">//</span> <span style="color:#66d9ef">under</span><span style="color:#f92672">-</span>development
</span></span></code></pre></div>
    </div>
</div>






  </div>
</div>
<p><br><br></p>
<h3 id="vm-27---use-azure-boost-vms-for-maintenance-sensitive-workload">VM-27 - Use Azure Boost VMs for Maintenance sensitive workload
  <a href="#vm-27---use-azure-boost-vms-for-maintenance-sensitive-workload">
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-link" viewBox="0 0 16 16">
      <path d="M6.354 5.5H4a3 3 0 0 0 0 6h3a3 3 0 0 0 2.83-4H9c-.086 0-.17.01-.25.031A2 2 0 0 1 7 10.5H4a2 2 0 1 1 0-4h1.535c.218-.376.495-.714.82-1z"/>
      <path d="M9 5.5a3 3 0 0 0-2.83 4h1.098A2 2 0 0 1 9 6.5h3a2 2 0 1 1 0 4h-1.535a4.02 4.02 0 0 1-.82 1H12a3 3 0 1 0 0-6H9z"/>
    </svg>
  </a>
</h3>
<p><strong>Category: Availability</strong></p>
<p><strong>Impact: Medium</strong></p>
<p><strong>Guidance</strong></p>
<p>If the workload is Maintenance sensitive, please consider using Azure Boost compatible VMs. Azure Boost is designed to lessen the impact on customers when Azure maintenance activities occur.</p>
<p><strong>Resources</strong></p>
<ul>
<li><a href="https://learn.microsoft.com/azure/azure-boost/overview">Microsoft Azure Boost</a></li>
<li><a href="https://aka.ms/AzureBoostGABlog">Announcing the general availability of Azure Boost</a></li>
</ul>
<p><strong>Resource Graph Query</strong></p>


<button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#collapse_481d94be0d" aria-expanded="false">
    Show/Hide Query/Script
</button>

<div class="collapse" id="collapse_481d94be0d">
  <div class="card card-body">
    







    
    




<div class="position-relative">
    <div class="position-absolute" style="right:0;">
        <button class="btn btn-light" data-clipboard-target="#clipboard_b581ba5583">
        Copy
        </button>
    </div>
    <div id="clipboard_b581ba5583">
    <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#f92672">//</span> <span style="color:#66d9ef">under</span><span style="color:#f92672">-</span>development
</span></span></code></pre></div>
    </div>
</div>






  </div>
</div>
<p><br><br></p>
<h3 id="vm-28---enable-scheduled-events-for-maintenance-sensitive-workload-vms">VM-28 - Enable Scheduled Events for Maintenance sensitive workload VMs
  <a href="#vm-28---enable-scheduled-events-for-maintenance-sensitive-workload-vms">
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-link" viewBox="0 0 16 16">
      <path d="M6.354 5.5H4a3 3 0 0 0 0 6h3a3 3 0 0 0 2.83-4H9c-.086 0-.17.01-.25.031A2 2 0 0 1 7 10.5H4a2 2 0 1 1 0-4h1.535c.218-.376.495-.714.82-1z"/>
      <path d="M9 5.5a3 3 0 0 0-2.83 4h1.098A2 2 0 0 1 9 6.5h3a2 2 0 1 1 0 4h-1.535a4.02 4.02 0 0 1-.82 1H12a3 3 0 1 0 0-6H9z"/>
    </svg>
  </a>
</h3>
<p><strong>Category: Availability</strong></p>
<p><strong>Impact: Medium</strong></p>
<p><strong>Guidance</strong></p>
<p>If the workload is Maintenance sensitive, please enable Scheduled Events. Scheduled Events is an Azure Metadata Service that gives your application time to prepare for virtual machine maintenance. It provides information about upcoming maintenance events (for example, reboot) so that your application can prepare for them and limit disruption. It&rsquo;s available for all Azure Virtual Machines types, including PaaS and IaaS on both Windows and Linux.</p>
<p><strong>Resources</strong></p>
<ul>
<li><a href="https://learn.microsoft.com/azure/virtual-machines/windows/scheduled-event-service">Monitor scheduled events for your Azure VMs</a></li>
<li><a href="https://learn.microsoft.com/azure/virtual-machines/linux/scheduled-events">Azure Metadata Service: Scheduled Events for Linux VMs</a></li>
<li><a href="https://learn.microsoft.com/azure/virtual-machines/windows/scheduled-events">Azure Metadata Service: Scheduled Events for Windows VMs</a></li>
</ul>
<p><strong>Resource Graph Query</strong></p>


<button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#collapse_481d94be0d" aria-expanded="false">
    Show/Hide Query/Script
</button>

<div class="collapse" id="collapse_481d94be0d">
  <div class="card card-body">
    







    
    




<div class="position-relative">
    <div class="position-absolute" style="right:0;">
        <button class="btn btn-light" data-clipboard-target="#clipboard_b581ba5583">
        Copy
        </button>
    </div>
    <div id="clipboard_b581ba5583">
    <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#f92672">//</span> <span style="color:#66d9ef">under</span><span style="color:#f92672">-</span>development
</span></span></code></pre></div>
    </div>
</div>






  </div>
</div>
<p><br><br></p>


    



          <div class="row"></div> 

        </div>

      </div> 

    </div> 
<script src="http://localhost:1313/Azure-Proactive-Resiliency-Library/lib/jquery.min.js"></script> 
<script src="http://localhost:1313/Azure-Proactive-Resiliency-Library/lib/popper.min.js"></script> 

<script src="http://localhost:1313/Azure-Proactive-Resiliency-Library/js/bootstrap.min.js"></script> 


<script type="text/javascript" src="/Azure-Proactive-Resiliency-Library/plugins/lunr.min.js"></script>
<script type="text/javascript" src="/Azure-Proactive-Resiliency-Library/plugins/auto-complete.js"></script>
<link href="/Azure-Proactive-Resiliency-Library/plugins/auto-complete.css" rel="stylesheet">
<script type="text/javascript">
  
      var baseurl = "http:\/\/localhost:1313\/Azure-Proactive-Resiliency-Library\/";
  
</script>
<script type="text/javascript" src="/Azure-Proactive-Resiliency-Library/plugins/search.js"></script>

<script type="text/javascript" src="/Azure-Proactive-Resiliency-Library/plugins/favorites.js"></script>


<script type="text/javascript" src="/Azure-Proactive-Resiliency-Library/plugins/clipboard.js"></script>
<script>
  new ClipboardJS('.btn');
</script>
</body>

</html>
